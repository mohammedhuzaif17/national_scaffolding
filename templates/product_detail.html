{% extends "base.html" %}

{% block title %}{{ product.name }} - National Scaffolding{% endblock %}

{% block content %}
<div class="glass-container">
    <button class="btn-secondary" onclick="history.back()" style="margin-bottom: 1rem;">‚Üê Back to Products</button>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}" style="width: 100%; border-radius: 10px;">
            {% else %}
            <div style="background: rgba(255, 255, 255, 0.1); padding: 5rem; text-align: center; border-radius: 10px;">
                <p style="color: #ffa500; font-size: 1.5rem;">üì¶</p>
                <p>Product Image</p>
            </div>
            {% endif %}
        </div>
        
        <div>
            <h1 class="page-title">{{ product.name }}</h1>
            <p style="color: #ffa500; text-transform: uppercase; margin-bottom: 1rem;">{{ product.category|title }}</p>
            <p style="margin-bottom: 2rem;">{{ product.description }}</p>
            
            {% if product.category == 'aluminium' %}
            <div class="customization-section">
                <h3 style="color: #ffa500; margin-bottom: 1rem;">Customize Your Product</h3>
                
                <div class="form-group">
                    <label>Width</label>
                    <select id="width" onchange="updateAluminiumPrice()">
                        <option value="0.7">Single Width (0.7 m)</option>
                        <option value="1.4">Double Width (1.4 m)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Height</label>
                    <select id="height" onchange="updateAluminiumPrice()">
                        <option value="2">2m</option>
                        <option value="3">3m</option>
                        <option value="4">4m</option>
                        <option value="5">5m</option>
                        <option value="6" disabled id="height_6">6m (Double Width Only)</option>
                        <option value="7" disabled id="height_7">7m (Double Width Only)</option>
                        <option value="8" disabled id="height_8">8m (Double Width Only)</option>
                        <option value="9" disabled id="height_9">9m (Double Width Only)</option>
                        <option value="10" disabled id="height_10">10m (Double Width Only)</option>
                        <option value="11" disabled id="height_11">11m (Double Width Only)</option>
                        <option value="12" disabled id="height_12">12m (Double Width Only)</option>
                        <option value="13" disabled id="height_13">13m (Double Width Only)</option>
                        <option value="14" disabled id="height_14">14m (Double Width Only)</option>
                        <option value="15" disabled id="height_15">15m (Double Width Only)</option>
                        <option value="16" disabled id="height_16">16m (Double Width Only)</option>
                    </select>
                </div>                
                <div class="form-group">
                    <label>Purchase Type</label>
                    <select id="purchase_type" onchange="updateAluminiumPrice()">
                        <option value="buy">Buy - ‚Çπ{{ product.price }}</option>
                        {% if product.rent_price %}
                        <option value="rent">Rent - ‚Çπ{{ product.rent_price }}/month</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <select id="quantity" onchange="updateAluminiumPrice()">
                        {% for i in range(1, 51) %}
                        <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% elif product.category == 'h-frames' %}
            <div class="customization-section">
                <h3 style="color: #ffa500; margin-bottom: 1rem;">Customize Your Order</h3>
                
                <div class="form-group">
                    <label>Quantity (Discount applies automatically)</label>
                    <select id="quantity" onchange="updateHFramePrice()">
                        {% for i in range(1, 101) %}
                        <option value="{{ i }}">{{ i }} {% if i == 1 %}piece{% else %}pieces{% endif %}{% if i >= 50 %} (12% OFF){% elif i >= 30 %} (10% OFF){% elif i >= 20 %} (7.5% OFF){% elif i >= 10 %} (5% OFF){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="discount_info" style="background: rgba(76, 175, 80, 0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="color: #4CAF50; font-weight: bold;">No discount yet</p>
                    <p style="font-size: 0.9rem;">
                        ‚Ä¢ 10-19 pieces: 5% off<br>
                        ‚Ä¢ 20-29 pieces: 7.5% off<br>
                        ‚Ä¢ 30-49 pieces: 10% off<br>
                        ‚Ä¢ 50-100 pieces: 12% off<br>
                        ‚Ä¢ 100+ pieces: Contact us for special pricing
                    </p>
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% elif product.category == 'cuplock' %}
            <div class="customization-section">
                <h3 style="color: #ffa500; margin-bottom: 1rem;">Customize Your Cuplock System</h3>
                
                <div style="background: rgba(30, 58, 138, 0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #ffa500; margin-bottom: 1rem;">Vertical Specifications <span style="color: red;">*</span></h4>
                    
                    <div class="form-group">
                        <label>Vertical Size <span style="color: red;">*</span></label>
                        <select id="vertical_size" required onchange="updateCuplockPrice()">
                            <option value="1">1m</option>
                            <option value="2">2m</option>
                            <option value="3">3m</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Number of Cups <span style="color: red;">*</span></label>
                        <select id="cups" required onchange="updateCuplockPrice()">
                            <option value="1">1 Cup</option>
                            <option value="2">2 Cups</option>
                            <option value="3">3 Cups</option>
                            <option value="4">4 Cups</option>
                            <option value="5">5 Cups</option>
                            <option value="6">6 Cups</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Length (1.1m - 3.0m) <span style="color: red;">*</span></label>
                        <input type="number" id="custom_length" value="1.1" min="1.1" max="3.0" step="0.1" required onchange="updateCuplockPrice()">
                    </div>
                </div>
                
                <div style="background: rgba(30, 58, 138, 0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #ffa500; margin-bottom: 1rem;">Ledger Specifications <span style="color: red;">*</span></h4>
                    
                    <div class="form-group">
                        <label>Ledger Size <span style="color: red;">*</span></label>
                        <select id="ledger_size" required onchange="updateCuplockPrice()">
                            <option value="0.5">0.5m</option>
                            <option value="0.73">0.73m</option>
                            <option value="1.0">1.0m</option>
                            <option value="1.09">1.09m</option>
                            <option value="1.4">1.4m</option>
                            <option value="1.57">1.57m</option>
                            <option value="2.07">2.07m</option>
                            <option value="2.57">2.57m</option>
                            <option value="3.07">3.07m</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <select id="quantity" onchange="updateCuplockPrice()">
                        {% for i in range(1, 101) %}
                        <option value="{{ i }}">{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <p style="background: rgba(255, 165, 0, 0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <strong>Pricing:</strong> ‚Çπ78 per kg
                </p>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% elif product.category == 'accessories' %}
            <div class="customization-section">
                <h3 style="color: #ffa500; margin-bottom: 1rem;">Select Quantity</h3>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" value="1" min="1" onchange="updateAccessoryPrice()">
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% else %}
            <div class="product-price">‚Çπ{{ product.price }}</div>
            {% if product.rent_price %}
            <p style="color: #4CAF50; margin-top: 1rem;">Rent: ‚Çπ{{ product.rent_price }}/month</p>
            {% endif %}
            
            <div class="form-group" style="margin-top: 2rem;">
                <label>Quantity</label>
                <select id="quantity">
                    {% for i in range(1, 51) %}
                    <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            {% if current_user.is_authenticated and session.get('user_type') == 'admin' %}
            <div style="background: rgba(255, 165, 0, 0.2); padding: 1.5rem; border-radius: 8px; margin-top: 2rem; text-align: center;">
                <p style="color: #ffa500; font-weight: bold; margin: 0;">
                    ‚ÑπÔ∏è Admin accounts cannot make purchases. Please use a customer account to add items to cart.
                </p>
            </div>
            {% elif current_user.is_authenticated %}
            <button class="btn-primary" onclick="addToCartCustom()" style="width: 100%; margin-top: 2rem; font-size: 1.1rem; padding: 1.2rem;">
                üõí Add to Cart
            </button>
            {% else %}
            <button class="btn-primary" onclick="window.location.href='{{ url_for('login') }}'" style="width: 100%; margin-top: 2rem; font-size: 1.1rem; padding: 1.2rem;">
                üîê Login to Purchase
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
const basePrice = {{ product.price }};
const rentPrice = {{ product.rent_price if product.rent_price else 0 }};
const category = '{{ product.category }}';
const weightPerUnit = {{ product.weight_per_unit if product.weight_per_unit else 5 }};

// Aluminium Scaffolding Pricing Matrix (Buy Prices)
const aluminiumPricing = {
    '0.7': {  // Single Width
        '2': 2500,
        '3': 3200,
        '4': 3800,
        '5': 4500
    },
    '1.4': {  // Double Width
        '2': 3500,
        '3': 4200,
        '4': 5000,
        '5': 5800,
        '6': 6500,
        '7': 7200,
        '8': 8000,
        '9': 8800,
        '10': 9500,
        '11': 10300,
        '12': 11000,
        '13': 11800,
        '14': 12500,
        '15': 13300,
        '16': 14000
    }
};

// Rent prices are 20% of buy prices
function getAluminiumPrice(width, height, purchaseType) {
    const widthKey = width.toString();
    const heightKey = height.toString();
    
    if (aluminiumPricing[widthKey] && aluminiumPricing[widthKey][heightKey]) {
        const buyPrice = aluminiumPricing[widthKey][heightKey];
        return purchaseType === 'rent' ? buyPrice * 0.2 : buyPrice;
    }
    
    // Fallback to base price if combination not found
    return purchaseType === 'buy' ? basePrice : rentPrice;
}

function updateAluminiumPrice() {
    const width = parseFloat(document.getElementById('width').value);
    const height = parseFloat(document.getElementById('height').value);
    const purchaseType = document.getElementById('purchase_type').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    // Disable heights > 5m for single width
    if (width === 0.7) {
        ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16'].forEach(h => {
            const opt = document.getElementById('height_' + h);
            if (opt) opt.disabled = true;
        });
        if (height > 5) document.getElementById('height').value = '2';
    } else {
        ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16'].forEach(h => {
            const opt = document.getElementById('height_' + h);
            if (opt) opt.disabled = false;
        });
    }
    
    const price = getAluminiumPrice(width, height, purchaseType);
    const total = price * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateHFramePrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    let discount = 0;
    let discountText = 'No discount yet';
    
    if (quantity > 100) {
        document.getElementById('discount_info').innerHTML = `
            <p style="color: #ff6b6b; font-weight: bold;">For orders of 100+ pieces, please contact us for special pricing!</p>
            <p style="font-size: 0.9rem;">Email: sales@nationalscaffolding.com | Phone: +91-XXXXXXXXXX</p>
        `;
        return;
    } else if (quantity >= 50) {
        discount = 0.12;
        discountText = '12% Discount Applied!';
    } else if (quantity >= 30) {
        discount = 0.10;
        discountText = '10% Discount Applied!';
    } else if (quantity >= 20) {
        discount = 0.075;
        discountText = '7.5% Discount Applied!';
    } else if (quantity >= 10) {
        discount = 0.05;
        discountText = '5% Discount Applied!';
    }
    
    const subtotal = basePrice * quantity;
    const discountAmount = subtotal * discount;
    const total = subtotal - discountAmount;
    
    document.getElementById('discount_info').innerHTML = `
        <p style="color: #4CAF50; font-weight: bold;">${discountText}</p>
        <p style="font-size: 0.9rem;">
            Subtotal: ‚Çπ${subtotal.toFixed(2)}<br>
            Discount: -‚Çπ${discountAmount.toFixed(2)}
        </p>
    `;
    
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateCuplockPrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const pricePerKg = 78;
    const total = pricePerKg * weightPerUnit * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateAccessoryPrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const total = basePrice * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function addToCartCustom() {
    const quantity = parseInt(document.getElementById('quantity').value);
    let customization = { quantity: quantity };
    let finalPrice = 0;
    let unitPrice = basePrice;
    
    if (category === 'aluminium') {
        const width = document.getElementById('width').value;
        const height = document.getElementById('height').value;
        const purchaseType = document.getElementById('purchase_type').value;
        customization = { width, height, purchaseType, quantity };
        unitPrice = getAluminiumPrice(parseFloat(width), parseFloat(height), purchaseType);
        finalPrice = unitPrice * quantity;
    } else if (category === 'h-frames') {
        let discount = 0;
        if (quantity > 100) {
            alert('For orders over 100 pieces, please contact us directly for special pricing.');
            return;
        } else if (quantity >= 50) {
            discount = 0.12;
        } else if (quantity >= 30) {
            discount = 0.10;
        } else if (quantity >= 20) {
            discount = 0.075;
        } else if (quantity >= 10) {
            discount = 0.05;
        }
        const subtotal = basePrice * quantity;
        finalPrice = subtotal * (1 - discount);
        unitPrice = finalPrice / quantity;
        customization = { quantity, discount_rate: discount };
    } else if (category === 'cuplock') {
        customization = {
            vertical_size: document.getElementById('vertical_size').value,
            cups: document.getElementById('cups').value,
            custom_length: document.getElementById('custom_length').value,
            ledger_size: document.getElementById('ledger_size').value,
            quantity
        };
        unitPrice = 78 * weightPerUnit;
        finalPrice = unitPrice * quantity;
    } else if (category === 'accessories') {
        unitPrice = basePrice;
        finalPrice = unitPrice * quantity;
    } else {
        unitPrice = basePrice;
        finalPrice = unitPrice * quantity;
    }
    
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            product_name: '{{ product.name }}',
            price: unitPrice,
            quantity: quantity,
            customization: customization
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ Product added to cart successfully!');
            setTimeout(() => {
                window.location.href = '{{ url_for("cart") }}';
            }, 1500);
        }
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

if (category === 'aluminium') {
    updateAluminiumPrice();
} else if (category === 'h-frames') {
    updateHFramePrice();
} else if (category === 'cuplock') {
    updateCuplockPrice();
} else if (category === 'accessories') {
    updateAccessoryPrice();
}
{% endblock %}

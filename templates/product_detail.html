{% extends "base.html" %}

{% block title %}{{ product.name }} - National Scaffolding{% endblock %}

{% block content %}
<div class="glass-container">
    <button class="btn-secondary" onclick="history.back()" style="margin-bottom: 1rem;">‚Üê Back to Products</button>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}" style="width: 100%; border-radius: 10px;">
            {% else %}
            <div style="background: rgba(255, 255, 255, 0.1); padding: 5rem; text-align: center; border-radius: 10px;">
                <p style="color: #ffa500; font-size: 1.5rem;">üì¶</p>
                <p>Product Image</p>
            </div>
            {% endif %}
        </div>
        
        <div>
            <h1 class="page-title">{{ product.name }}</h1>
            <p style="color: #ffa500; text-transform: uppercase; margin-bottom: 1rem;">{{ product.category|title }}</p>
            <p style="margin-bottom: 2rem;">{{ product.description }}</p>
            
            {% if product.category == 'aluminium' %}
            <div class="customization-section">
                <h3 style="color: #ffa500; margin-bottom: 1rem;">Customize Your Product</h3>
                
                <div class="form-group">
                    <label>Width</label>
                    <select id="width" onchange="updateAluminiumPrice()">
                        <option value="0.7">Single Width (0.7 m)</option>
                        <option value="1.4">Double Width (1.4 m)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Height</label>
                    <select id="height" onchange="updateAluminiumPrice()">
                        <option value="2">2m</option>
                        <option value="3">3m</option>
                        <option value="4">4m</option>
                        <option value="5">5m</option>
                        <option value="6" disabled id="height_6">6m (Double Width Only)</option>
                        <option value="7" disabled id="height_7">7m (Double Width Only)</option>
                        <option value="8" disabled id="height_8">8m (Double Width Only)</option>
                        <option value="9" disabled id="height_9">9m (Double Width Only)</option>
                        <option value="10" disabled id="height_10">10m (Double Width Only)</option>
                        <option value="11" disabled id="height_11">11m (Double Width Only)</option>
                        <option value="12" disabled id="height_12">12m (Double Width Only)</option>
                        <option value="13" disabled id="height_13">13m (Double Width Only)</option>
                        <option value="14" disabled id="height_14">14m (Double Width Only)</option>
                        <option value="15" disabled id="height_15">15m (Double Width Only)</option>
                        <option value="16" disabled id="height_16">16m (Double Width Only)</option>
                    </select>
                </div>                
                <div class="form-group">
                    <label>Purchase Type</label>
                    <select id="purchase_type" onchange="updateAluminiumPrice()">
                        <option value="buy">Buy</option>
                        {% if product.rent_price %}
                        <option value="rent">Rent</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <select id="quantity" onchange="updateAluminiumPrice()">
                        {% for i in range(1, 51) %}
                        <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% elif product.category == 'h-frames' %}
            <div class="customization-section">
                <div class="form-group">
                    <label>Purchase Type</label>
                    <select id="purchase_type" onchange="updateHFramePrice()">
                        <option value="buy">Buy</option>
                        {% if product.rent_price %}
                        <option value="rent">Rent</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <select id="quantity" onchange="updateHFramePrice()">
                        {% for i in range(1, 201) %}
                        <option value="{{ i }}">{{ i }} {% if i == 1 %}set{% else %}sets{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% elif product.category == 'cuplock' %}
            <div class="customization-section" style="max-width: 100%;">
                {% if 'Vertical' in product.name %}
                <div style="background: rgba(30, 58, 138, 0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; width: 100%;">
                    <h4 style="color: #ffa500; margin-bottom: 1rem;">Vertical Specifications</h4>
                    
                    <div class="form-group">
                        <label>Vertical Size</label>
                        <select id="vertical_size">
                            <option value="1">1m</option>
                            <option value="2">2m</option>
                            <option value="3">3m</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Number of Cups</label>
                        <select id="cups">
                            <option value="1">1 Cup</option>
                            <option value="2">2 Cups</option>
                            <option value="3">3 Cups</option>
                            <option value="4">4 Cups</option>
                            <option value="5">5 Cups</option>
                            <option value="6">6 Cups</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Custom Length (1.1m - 3.0m)</label>
                        <input type="number" id="custom_length" value="1.1" min="1.1" max="3.0" step="0.1">
                    </div>
                </div>
                {% elif 'Ledger' in product.name %}
                <div style="background: rgba(30, 58, 138, 0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; width: 100%;">
                    <h4 style="color: #ffa500; margin-bottom: 1rem;">Ledger Specifications</h4>
                    
                    <div class="form-group">
                        <label>Ledger Size</label>
                        <select id="ledger_size">
                            <option value="0.5">0.5m</option>
                            <option value="0.73">0.73m</option>
                            <option value="1.0">1.0m</option>
                            <option value="1.09">1.09m</option>
                            <option value="1.4">1.4m</option>
                            <option value="1.57">1.57m</option>
                            <option value="2.07">2.07m</option>
                            <option value="2.57">2.57m</option>
                            <option value="3.07">3.07m</option>
                        </select>
                    </div>
                </div>
                {% endif %}
                
                <div style="background: linear-gradient(135deg, #001d3d 0%, #003d7a 100%); padding: 2rem; border-radius: 12px; margin: 1.5rem 0; border: 2px solid #d4af37; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);">
                    <h3 style="color: #d4af37; margin-bottom: 1rem; text-align: center;">Product Information</h3>
                    <p style="color: #ffffff; font-size: 1.1rem; line-height: 1.8; text-align: center;">
                        This product is available for both <strong style="color: #d4af37;">rent</strong> and <strong style="color: #d4af37;">sale</strong>.<br>
                        For detailed pricing, specifications, and availability,<br>
                        please contact us directly.
                    </p>
                    <div style="margin-top: 1.5rem; text-align: center; padding-top: 1rem; border-top: 1px solid rgba(212, 175, 55, 0.3);">
                        <p style="color: #d4af37; font-weight: bold; margin-bottom: 0.5rem;">Contact Us:</p>
                        <p style="color: #ffffff;">
                            üìß Email: sales@nationalscaffolding.com<br>
                            üìû Phone: +91-XXXXXXXXXX
                        </p>
                    </div>
                </div>
            </div>
            
            {% elif product.category == 'accessories' %}
            <div class="customization-section">
                <div class="form-group">
                    <label>Purchase Type</label>
                    <select id="purchase_type" onchange="updateAccessoryPrice()">
                        <option value="buy">Buy</option>
                        {% if product.rent_price %}
                        <option value="rent">Rent</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" value="1" min="1" onchange="updateAccessoryPrice()">
                </div>
                
                <div class="product-price" id="final_price">‚Çπ{{ product.price }}</div>
            </div>
            
            {% else %}
            <div class="product-price">‚Çπ{{ product.price }}</div>
            {% if product.rent_price %}
            <p style="color: #4CAF50; margin-top: 1rem;">Rent: ‚Çπ{{ product.rent_price }}/month</p>
            {% endif %}
            
            <div class="form-group" style="margin-top: 2rem;">
                <label>Quantity</label>
                <select id="quantity">
                    {% for i in range(1, 51) %}
                    <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            {% if product.category != 'cuplock' %}
                {% if current_user.is_authenticated and session.get('user_type') == 'admin' %}
                <div style="background: rgba(255, 165, 0, 0.2); padding: 1.5rem; border-radius: 8px; margin-top: 2rem; text-align: center;">
                    <p style="color: #ffa500; font-weight: bold; margin: 0;">
                        ‚ÑπÔ∏è Admin accounts cannot make purchases. Please use a customer account to add items to cart.
                    </p>
                </div>
                {% elif current_user.is_authenticated %}
                <button class="btn-primary" onclick="addToCartCustom()" style="width: 100%; margin-top: 2rem; font-size: 1.1rem; padding: 1.2rem;">
                    üõí Add to Cart
                </button>
                {% else %}
                <button class="btn-primary" onclick="window.location.href='{{ url_for('login') }}'" style="width: 100%; margin-top: 2rem; font-size: 1.1rem; padding: 1.2rem;">
                    üîê Login to Purchase
                </button>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
const basePrice = {{ product.price }};
const rentPrice = {{ product.rent_price if product.rent_price else 0 }};
const category = '{{ product.category }}';
const weightPerUnit = {{ product.weight_per_unit if product.weight_per_unit else 5 }};

// Aluminium Scaffolding Pricing Matrix (Load from Database)
const aluminiumPricing = {{ product.customization_options.get('pricing_matrix', {})|tojson|safe if product.customization_options else '{}' }};

// Get aluminium price from pricing matrix (handles both old and new formats)
function getAluminiumPrice(width, height, purchaseType) {
    const widthKey = width.toString();
    const heightKey = height.toString();
    
    if (aluminiumPricing[widthKey] && aluminiumPricing[widthKey][heightKey]) {
        const priceData = aluminiumPricing[widthKey][heightKey];
        
        // Handle both old format (single number) and new format (object with buy/rent)
        if (typeof priceData === 'object') {
            // New format: {buy: xxx, rent: yyy}
            if (purchaseType === 'rent') {
                // Use rent price if available, otherwise calculate as 20% of buy
                return priceData.rent || (priceData.buy ? priceData.buy * 0.2 : rentPrice);
            } else {
                return priceData.buy || basePrice;
            }
        } else {
            // Old format: just a number (buy price)
            const buyPrice = priceData;
            return purchaseType === 'rent' ? buyPrice * 0.2 : buyPrice;
        }
    }
    
    // Fallback to base price if combination not found
    return purchaseType === 'buy' ? basePrice : rentPrice;
}

function updateAluminiumPrice() {
    const width = parseFloat(document.getElementById('width').value);
    const height = parseFloat(document.getElementById('height').value);
    const purchaseType = document.getElementById('purchase_type').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    // Disable heights > 5m for single width
    if (width === 0.7) {
        ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16'].forEach(h => {
            const opt = document.getElementById('height_' + h);
            if (opt) opt.disabled = true;
        });
        if (height > 5) document.getElementById('height').value = '2';
    } else {
        ['6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16'].forEach(h => {
            const opt = document.getElementById('height_' + h);
            if (opt) opt.disabled = false;
        });
    }
    
    const price = getAluminiumPrice(width, height, purchaseType);
    const total = price * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateHFramePrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const purchaseType = document.getElementById('purchase_type').value;
    const price = purchaseType === 'rent' ? rentPrice : basePrice;
    const total = price * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateCuplockPrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const pricePerKg = 78;
    const total = pricePerKg * weightPerUnit * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function updateAccessoryPrice() {
    const quantity = parseInt(document.getElementById('quantity').value);
    const purchaseType = document.getElementById('purchase_type').value;
    const price = purchaseType === 'rent' ? rentPrice : basePrice;
    const total = price * quantity;
    document.getElementById('final_price').textContent = '‚Çπ' + total.toFixed(2);
}

function addToCartCustom() {
    const quantity = parseInt(document.getElementById('quantity').value);
    let customization = { quantity: quantity };
    let finalPrice = 0;
    let unitPrice = basePrice;
    
    if (category === 'aluminium') {
        const width = document.getElementById('width').value;
        const height = document.getElementById('height').value;
        const purchaseType = document.getElementById('purchase_type').value;
        customization = { width, height, purchaseType, quantity };
        unitPrice = getAluminiumPrice(parseFloat(width), parseFloat(height), purchaseType);
        finalPrice = unitPrice * quantity;
    } else if (category === 'h-frames') {
        const purchaseType = document.getElementById('purchase_type').value;
        unitPrice = purchaseType === 'rent' ? rentPrice : basePrice;
        finalPrice = unitPrice * quantity;
        customization = { quantity, purchaseType };
    } else if (category === 'cuplock') {
        customization = {
            vertical_size: document.getElementById('vertical_size').value,
            cups: document.getElementById('cups').value,
            custom_length: document.getElementById('custom_length').value,
            ledger_size: document.getElementById('ledger_size').value,
            quantity
        };
        unitPrice = 78 * weightPerUnit;
        finalPrice = unitPrice * quantity;
    } else if (category === 'accessories') {
        const purchaseType = document.getElementById('purchase_type').value;
        unitPrice = purchaseType === 'rent' ? rentPrice : basePrice;
        finalPrice = unitPrice * quantity;
        customization = { quantity, purchaseType };
    } else {
        unitPrice = basePrice;
        finalPrice = unitPrice * quantity;
    }
    
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: {{ product.id }},
            product_name: '{{ product.name }}',
            price: unitPrice,
            quantity: quantity,
            customization: customization
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('‚úÖ Product added to cart successfully!');
            setTimeout(() => {
                window.location.href = '{{ url_for("cart") }}';
            }, 1500);
        }
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

if (category === 'aluminium') {
    updateAluminiumPrice();
} else if (category === 'h-frames') {
    updateHFramePrice();
} else if (category === 'cuplock') {
    updateCuplockPrice();
} else if (category === 'accessories') {
    updateAccessoryPrice();
}
{% endblock %}

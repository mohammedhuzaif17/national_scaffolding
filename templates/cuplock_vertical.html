{% extends "base.html" %}

{% block title %}Vertical Cuplock - {{ product.name }}{% endblock %}

{% block content %}
<div class="product-container">

    <h1>{{ product.name }}</h1>
    <p>{{ product.description }}</p>

    <!-- PRODUCT IMAGE -->
    <div style="text-align:center;margin-bottom:20px;">
        <img src="{{ url_for('static', filename=product.display_image_url) }}"
             style="max-width:300px;border-radius:8px;">
    </div>

    <!-- PURCHASE TYPE -->
    <div class="purchase-type-section">
        <label>
            <input type="radio" name="purchaseType" value="buy" checked onchange="updatePurchaseType()">
            Buy
        </label>
        <label>
            <input type="radio" name="purchaseType" value="rent" onchange="updatePurchaseType()">
            Rent (per day)
        </label>
    </div>

    <!-- SIZE -->
    <div class="form-group">
        <label>Select Size *</label>
        <select id="sizeSelect" onchange="loadCups()">
            <option value="">-- Select Size --</option>
            {% for size in sizes %}
            <option
                value="{{ size.id }}"
                data-label="{{ size.size_label }}"
                data-rent="{{ size.rent_price }}"
                data-deposit="{{ size.deposit }}">
                {{ size.size_label }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- CUP SECTION -->
    <div id="cupSection" style="display:block;">
        <h3>Select Cup Configuration *</h3>
        <div id="cupImagesContainer" class="cup-images-grid"></div>
    </div>

    <!-- QUANTITY -->
    <div class="form-group">
        <label>Quantity *</label>
        <input type="number" id="quantity" value="1" min="1" onchange="updatePrice()">
    </div>

    <!-- PRICE -->
    <div class="price-display">
        <div class="price-row">
            <span>Unit Price:</span>
            <span id="unitPrice">₹0.00</span>
        </div>

        <div class="price-row" id="depositRow" style="display:none">
            <span>Deposit (per unit):</span>
            <span id="depositAmount">₹0.00</span>
        </div>

        <div class="price-row total-row">
            <span>Total:</span>
            <span id="totalPrice">₹0.00</span>
        </div>
    </div>

    <!-- ADD TO CART -->
    <button type="button" class="btn btn-warning" onclick="addToCart()">
        Add to Cart
    </button>

</div>
<script>
/* ================== GLOBALS ================== */
const PRODUCT_BASE_PRICE = {{ product.price|default(0) }};
let selectedCupPrice = 0;
let rentPrice = 0;
let depositPrice = 0;
let selectedSizeLabel = null;
let selectedCupId = null;

/* ================== PURCHASE TYPE ================== */
function updatePurchaseType() {
    const type = document.querySelector("input[name='purchaseType']:checked").value;
    document.getElementById('cupSection').style.display =
        (type === 'buy') ? 'block' : 'none';
    updatePrice();
}

/* ================== LOAD CUP OPTIONS ================== */
function loadCups() {
    const select = document.getElementById('sizeSelect');
    const option = select.selectedOptions[0];

    if (!option || !option.value) {
        selectedCupPrice = 0;
        selectedCupId = null;
        updatePrice();
        return;
    }

    const sizeId = option.value;
    selectedSizeLabel = option.dataset.label;

    rentPrice = parseFloat(option.dataset.rent || 0);
    depositPrice = parseFloat(option.dataset.deposit || 0);

    fetch(`/api/vertical/size/${sizeId}/cups`)
        .then(res => res.json())
        .then(cups => {
            const container = document.getElementById('cupImagesContainer');
            container.innerHTML = '';
            selectedCupPrice = 0;
            selectedCupId = null;

            if (!cups.length) {
                container.innerHTML = '<p>No cup options available</p>';
                updatePrice();
                return;
            }

            cups.forEach(c => {
                const card = document.createElement('div');
                card.className = 'cup-image-card';

                card.innerHTML = `
                    <img src="/static/${c.image_url}">
                    <p>${c.cup_count} Cups</p>
                    <p class="cup-price">₹${c.buy_price}</p>
                `;

                card.onclick = () => {
                    selectedCupPrice = parseFloat(c.buy_price);
                    selectedCupId = c.id;

                    document.querySelectorAll('.cup-image-card')
                        .forEach(el => el.classList.remove('selected'));
                    card.classList.add('selected');

                    updatePrice();
                };

                container.appendChild(card);
            });

            updatePrice();
        });
}

/* ================== PRICE PREVIEW ================== */
function updatePrice() {
    const qty = parseInt(document.getElementById('quantity').value) || 1;
    const type = document.querySelector("input[name='purchaseType']:checked").value;

    let unit = 0;
    let deposit = 0;

    if (type === 'buy') {
        unit = PRODUCT_BASE_PRICE + selectedCupPrice;
    } else {
        unit = rentPrice;
        deposit = depositPrice;
    }

    const total = (unit * qty) + (deposit * qty);

    document.getElementById('unitPrice').innerText = `₹${unit.toFixed(2)}`;
    document.getElementById('depositAmount').innerText = `₹${deposit.toFixed(2)}`;
    document.getElementById('totalPrice').innerText = `₹${total.toFixed(2)}`;

    document.getElementById('depositRow').style.display =
        (type === 'rent' && deposit > 0) ? 'flex' : 'none';
}

/* ================== ADD TO CART ================== */
function addToCart() {
    const qty = parseInt(document.getElementById('quantity').value) || 1;
    const type = document.querySelector("input[name='purchaseType']:checked").value;

    if (!selectedSizeLabel || (type === 'buy' && !selectedCupId)) {
        alert("Please select size and cup configuration");
        return;
    }

    fetch('/add_to_cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            product_id: {{ product.id }},
            quantity: qty,
            customization: {
                component: "vertical",
                purchaseType: type,
                size: selectedSizeLabel,
                cup_id: selectedCupId
            }
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/cart';
        } else {
            alert(data.message);
        }
    });
}

document.addEventListener("DOMContentLoaded", updatePurchaseType);
</script>






<style> /* --- your styling kept exactly as you wrote it (cleaned version) --- */ .product-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); } .product-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e0e0e0; } .product-header h1 { color: #001d3d; margin-bottom: .5rem; } .product-description { color: #666; } .purchase-type-section { margin-bottom: 2rem; } .radio-group { display: flex; gap: 1.5rem; } .radio-option { display: flex; align-items: center; gap: .5rem; padding: .75rem 1.5rem; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; } .radio-option input:checked + span { color: #002855; font-weight: 600; } .radio-option:has(input:checked) { background: #f0f7ff; border-color: #002855; } .form-group { margin-bottom: 1.5rem; } .price-display { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin: 2rem 0; } .price-row { display: flex; justify-content: space-between; padding: .75rem 0; border-bottom: 1px solid #e0e0e0; } .total-row { font-size: 1.2rem; font-weight: bold; margin-top: .5rem; padding-top: 1rem; border-top: 2px solid #001d3d; } .price-value { color: #d4af37; font-weight: 700; } .btn-primary { background: linear-gradient(135deg, #002855, #004a99); color: white; width: 100%; padding: 1rem; font-size: 1.1rem; border-radius: 8px; } .error-message { text-align: center; padding: 2rem; } .cup-images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1rem; } .cup-image-card { border: 2px solid #ddd; border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.3s; background: white; } .cup-image-card:hover { border-color: #002855; box-shadow: 0 4px 12px rgba(0, 40, 85, 0.2); } .cup-image-card.selected { border-color: #d4af37; background: #f0f7ff; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); } .cup-image-card img { max-width: 100%; height: 100px; object-fit: contain; margin-bottom: 0.5rem; } .cup-image-card .no-image { width: 100%; height: 100px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 0.5rem; background: #f0f0f0; border-radius: 4px; } .cup-image-card p { margin: 0.25rem 0; font-size: 0.9rem; color: #333; } .cup-image-card .cup-price { font-weight: bold; color: #d4af37; } </style>

{% endblock %}

{% extends "base.html" %}

{% block title %}Vertical Cuplock - {{ product.name }}{% endblock %}

{% block content %}
<div class="product-container">

    <h1>{{ product.name }}</h1>
    <p>{{ product.description }}</p>

    <!-- PRODUCT IMAGE -->
    <div style="text-align:center;margin-bottom:20px;">
        <img src="{{ url_for('static', filename=product.display_image_url) }}"
             style="max-width:300px;border-radius:8px;">
    </div>

    <!-- PURCHASE TYPE -->
    <div class="purchase-type-section">
        <label>
            <input type="radio" name="purchaseType" value="buy" checked onchange="updatePurchaseType()">
            Buy
        </label>
        <label>
            <input type="radio" name="purchaseType" value="rent" onchange="updatePurchaseType()">
            Rent (per day)
        </label>
    </div>

    <!-- SIZE -->
    <div class="form-group">
        <label>Select Size *</label>
        <select id="sizeSelect" onchange="loadCups()">
            <option value="">-- Select Size --</option>
            {% for size in sizes %}
            <option
                value="{{ size.id }}"
                data-label="{{ size.size_label }}"
                data-rent="{{ size.rent_price }}"
                data-deposit="{{ size.deposit }}">
                {{ size.size_label }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- CUP SECTION -->
    <div id="cupSection" style="display:block;">
        <h3>Select Cup Configuration *</h3>
        <div id="cupImagesContainer" class="cup-images-grid"></div>
    </div>

    <!-- QUANTITY -->
    <div class="form-group">
        <label>Quantity *</label>
        <input type="number" id="quantity" value="1" min="1" onchange="updatePrice()">
    </div>

    <!-- PRICE -->
    <div class="price-display">
        <div class="price-row">
            <span>Unit Price:</span>
            <span id="unitPrice">₹0.00</span>
        </div>

        <div class="price-row" id="depositRow" style="display:none">
            <span>Deposit (per unit):</span>
            <span id="depositAmount">₹0.00</span>
        </div>

        <div class="price-row total-row">
            <span>Total:</span>
            <span id="totalPrice">₹0.00</span>
        </div>
    </div>

    <!-- ADD TO CART -->
    <button type="button" class="btn btn-warning" onclick="addToCart()">
        Add to Cart
    </button>

</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    
    /* ================== GLOBALS ================== */
    const PRODUCT_BASE_PRICE = {{ product.price|default(0) }};
    let selectedCupPrice = 0;
    let rentPrice = 0;
    let depositPrice = 0;
    let selectedSizeLabel = null;
    let selectedCupId = null;

    /* ================== PURCHASE TYPE ================== */
    function updatePurchaseType() {
        try {
            const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
            const cupSection = document.getElementById('cupSection');
            
            if (!purchaseTypeRadios || !cupSection) {
                console.error('Required elements not found');
                return;
            }
            
            let isBuySelected = false;
            purchaseTypeRadios.forEach(function(radio) {
                if (radio.checked && radio.value === 'buy') {
                    isBuySelected = true;
                }
            });
            
            cupSection.style.display = isBuySelected ? 'block' : 'none';
            updatePrice();
        } catch (error) {
            console.error('Error in updatePurchaseType:', error);
        }
    }

    /* ================== LOAD CUP OPTIONS ================== */
    function loadCups() {
        try {
            const sizeSelect = document.getElementById('sizeSelect');
            if (!sizeSelect) {
                console.error('Size select element not found');
                return;
            }
            
            const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];

            // Clear selections if no option selected
            if (!selectedOption || !selectedOption.value) {
                selectedCupPrice = 0;
                selectedCupId = null;
                selectedSizeLabel = null;
                rentPrice = 0;
                depositPrice = 0;
                updatePrice();
                return;
            }

            const sizeId = selectedOption.value;
            selectedSizeLabel = selectedOption.getAttribute('data-label') || '';

            // Safely get dataset values with fallbacks
            const rentValue = selectedOption.getAttribute('data-rent');
            const depositValue = selectedOption.getAttribute('data-deposit');
            
            rentPrice = rentValue ? parseFloat(rentValue) : 0;
            depositPrice = depositValue ? parseFloat(depositValue) : 0;

            fetch('/cuplock/api/vertical/size/' + encodeURIComponent(sizeId) + '/cups')
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    const container = document.getElementById('cupImagesContainer');
                    if (container) {
                        container.innerHTML = '';
                    }
                    selectedCupPrice = 0;
                    selectedCupId = null;

                    if (!data.success || !data.cups || data.cups.length === 0) {
                        if (container) {
                            container.innerHTML = '<p>No cup options available</p>';
                        }
                        updatePrice();
                        return;
                    }

                    const cups = data.cups;
                    cups.forEach(function(c) {
                        const card = document.createElement('div');
                        card.className = 'cup-image-card';

                        // Handle missing image_url
                        const imageUrl = c.image_url || '/static/images/no-image.png';

                        card.innerHTML = '<img src="/static/' + imageUrl + '" onerror="this.src=\'/static/images/no-image.png\'">' +
                            '<p>' + c.cup_count + ' Cups</p>' +
                            '<p class="cup-price">₹' + (c.buy_price || 0).toFixed(2) + '</p>';

                        // Add click handler
                        card.addEventListener('click', function() {
                            selectedCupPrice = parseFloat(c.buy_price || 0);
                            selectedCupId = c.id;

                            // Remove selected class from all cards
                            document.querySelectorAll('.cup-image-card').forEach(function(el) {
                                el.classList.remove('selected');
                            });
                            card.classList.add('selected');

                            updatePrice();
                        });

                        if (container) {
                            container.appendChild(card);
                        }
                    });

                    updatePrice();
                })
                .catch(function(error) {
                    console.error('Error loading cups:', error);
                    const container = document.getElementById('cupImagesContainer');
                    if (container) {
                        container.innerHTML = '<p style="color: red;">Error loading cup options</p>';
                    }
                    updatePrice();
                });
        } catch (error) {
            console.error('Error in loadCups:', error);
        }
    }

    /* ================== PRICE PREVIEW ================== */
    function updatePrice() {
        try {
            const qtyInput = document.getElementById('quantity');
            const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
            
            // Get quantity with fallback
            const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
            
            // Get purchase type with fallback
            let type = 'buy'; // default
            if (purchaseTypeRadios) {
                purchaseTypeRadios.forEach(function(radio) {
                    if (radio.checked && radio.value === 'rent') {
                        type = 'rent';
                    }
                });
            }

            let unit = 0;
            let deposit = 0;

            if (type === 'buy') {
                unit = PRODUCT_BASE_PRICE + selectedCupPrice;
            } else {
                unit = rentPrice;
                deposit = depositPrice;
            }

            const total = (unit * qty) + (deposit * qty);

            // Update display with safety checks
            const unitPriceEl = document.getElementById('unitPrice');
            const depositAmountEl = document.getElementById('depositAmount');
            const totalPriceEl = document.getElementById('totalPrice');
            const depositRowEl = document.getElementById('depositRow');

            if (unitPriceEl) unitPriceEl.innerText = '₹' + unit.toFixed(2);
            if (depositAmountEl) depositAmountEl.innerText = '₹' + deposit.toFixed(2);
            if (totalPriceEl) totalPriceEl.innerText = '₹' + total.toFixed(2);
            if (depositRowEl) {
                depositRowEl.style.display = (type === 'rent' && deposit > 0) ? 'flex' : 'none';
            }
        } catch (error) {
            console.error('Error in updatePrice:', error);
        }
    }

    /* ================== ADD TO CART ================== */
    function addToCart() {
        try {
            const qtyInput = document.getElementById('quantity');
            const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
            
            const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
            
            // Get purchase type with fallback
            let type = 'buy'; // default
            if (purchaseTypeRadios) {
                purchaseTypeRadios.forEach(function(radio) {
                    if (radio.checked && radio.value === 'rent') {
                        type = 'rent';
                    }
                });
            }

            if (!selectedSizeLabel || (type === 'buy' && !selectedCupId)) {
                alert("Please select size and cup configuration");
                return;
            }

            const customization = {
                component: "vertical",
                purchase_type: type,
                size: selectedSizeLabel,
                cup_id: selectedCupId
            };

            fetch('/add_to_cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_id: {{ product.id|tojson }},
                    quantity: qty,
                    customization: customization
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    window.location.href = '/cart';
                } else {
                    alert(data.message || 'Failed to add to cart');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Error adding to cart');
            });
        } catch (error) {
            console.error('Error in addToCart:', error);
        }
    }

    // Initialize on page load
    try {
        updatePurchaseType();
        updatePrice();
        console.log('Page initialized successfully');
    } catch (error) {
        console.error('Error during initialization:', error);
    }
});
</script>

<style>
.product-container { 
    max-width: 800px; 
    margin: 2rem auto; 
    padding: 2rem; 
    background: white; 
    border-radius: 12px; 
    box-shadow: 0 4px 16px rgba(0,0,0,0.1); 
}

.purchase-type-section { 
    margin-bottom: 2rem; 
    display: flex; 
    gap: 1rem; 
}

.purchase-type-section label { 
    display: flex; 
    align-items: center; 
    gap: 0.5rem; 
    padding: 0.5rem 1rem; 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    cursor: pointer; 
}

.purchase-type-section input:checked + label { 
    background: #f0f7ff; 
    border-color: #002855; 
}

.form-group { 
    margin-bottom: 1.5rem; 
}

.form-group label { 
    display: block; 
    margin-bottom: 0.5rem; 
    font-weight: 600; 
}

.form-group select, 
.form-group input { 
    width: 100%; 
    padding: 0.75rem; 
    border: 1px solid #ddd; 
    border-radius: 4px; 
    font-size: 1rem; 
}

.cup-images-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap: 1rem; 
    margin: 1rem 0; 
}

.cup-image-card { 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    padding: 1rem; 
    text-align: center; 
    cursor: pointer; 
    transition: all 0.3s; 
    background: white; 
}

.cup-image-card:hover { 
    border-color: #002855; 
    box-shadow: 0 4px 12px rgba(0, 40, 85, 0.2); 
}

.cup-image-card.selected { 
    border-color: #d4af37; 
    background: #f0f7ff; 
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); 
}

.cup-image-card img { 
    max-width: 100%; 
    height: 100px; 
    object-fit: contain; 
    margin-bottom: 0.5rem; 
}

.cup-image-card p { 
    margin: 0.25rem 0; 
    font-size: 0.9rem; 
    color: #333; 
}

.cup-image-card .cup-price { 
    font-weight: bold; 
    color: #d4af37; 
}

.price-display { 
    background: #f8f9fa; 
    border-radius: 8px; 
    padding: 1.5rem; 
    margin: 2rem 0; 
}

.price-row { 
    display: flex; 
    justify-content: space-between; 
    padding: 0.75rem 0; 
    border-bottom: 1px solid #e0e0e0; 
}

.total-row { 
    font-size: 1.2rem; 
    font-weight: bold; 
    margin-top: 0.5rem; 
    padding-top: 1rem; 
    border-top: 2px solid #001d3d; 
}

.btn-warning { 
    background: #f39c12; 
    color: white; 
    width: 100%; 
    padding: 1rem; 
    font-size: 1.1rem; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
}

.btn-warning:hover { 
    background: #e67e00; 
}
</style>
{% endblock %}
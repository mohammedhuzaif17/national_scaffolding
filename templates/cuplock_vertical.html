{% extends "base.html" %}

{% block title %}Vertical Cuplock - {{ product.name }}{% endblock %}

{% block content %}
<style>
    /* Keep all your existing styles - they're good */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
        color: #333;
        padding-bottom: 60px;
    }

    .product-container {
        width: 100%;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow-x: hidden;
    }

    h1 {
        font-size: 2rem;
        color: #1e3a8a;
        margin-bottom: 1.5rem;
        font-weight: 700;
    }

    .product-image {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 30px auto;
        overflow: hidden;
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        min-height: 200px;
    }

    .product-image img {
        max-width: 100%;
        max-height: 300px;
        width: auto;
        height: auto;
        object-fit: contain;
        border-radius: 4px;
    }

    .info-box {
        background: #e3f2fd;
        border-left: 5px solid #1976d2;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        font-size: 0.95rem;
    }

    .info-box strong {
        color: #1976d2;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 1rem;
    }

    .info-box ul {
        list-style: none;
        margin: 0;
        padding-left: 1rem;
    }

    .info-box li {
        color: #444;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .purchase-type-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .purchase-type-section label {
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 0;
        padding: 0;
        display: block;
    }

    .radio-group {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
    }

    .radio-group input[type="radio"] {
        appearance: none;
        width: 0;
        height: 0;
        opacity: 0;
        position: absolute;
    }

    .radio-group label {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
        font-weight: 600;
        color: #444;
    }

    .radio-group label:hover {
        border-color: #1e3a8a;
        background: #f0f7ff;
    }

    .radio-group input[type="radio"]:checked + label {
        border-color: #1e3a8a;
        background: #1e3a8a;
        color: white;
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.2);
    }

    .radio-group label::before {
        content: '';
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #ccc;
        background: #fff;
        margin-right: 15px;
        flex-shrink: 0;
    }

    .radio-group input[type="radio"]:checked + label::before {
        background: #fff;
        border-color: #fff;
        box-shadow: inset 0 0 0 4px rgba(0,0,0,0.3);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: #333;
        font-size: 1rem;
    }

    .form-group select, .form-group input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px !important;
        background-color: #fff;
        font-family: inherit;
        color: #333;
        transition: border-color 0.3s ease;
        -webkit-appearance: none;
    }

    .form-group select:focus, .form-group input:focus {
        border-color: #1e3a8a;
        outline: none;
        box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.15);
    }

    .cup-options-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .cup-option-card {
        border: 3px solid #ddd;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .cup-option-card:hover {
        border-color: #1e3a8a;
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .cup-option-card.selected {
        border-color: #1e3a8a;
        background: #e3f2fd;
        color: #1e3a8a;
        font-weight: 700;
    }

    .cup-option-card.selected::after {
        content: '‚úì';
        position: absolute;
        top: 10px;
        right: 10px;
        background: #1e3a8a;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .cup-options-grid .empty-msg {
        grid-column: 1 / -1;
        padding: 2rem;
        color: #999;
        font-style: italic;
    }

    .add-cup-form {
        background: #fff3cd;
        border: 1px solid #ffecb5;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        text-align: center;
    }

    .add-cup-form h5 {
        margin: 0 0 1rem 0;
        color: #333;
        font-size: 1.1rem;
    }

    .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .price-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }

    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        font-size: 1.1rem;
    }

    .price-row:last-child {
        margin-top: 0.5rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.2);
    }

    .total-row {
        font-weight: 800;
        font-size: 1.5rem;
    }

    .btn {
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .btn-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        width: 100%;
        padding: 1.2rem 2rem;
        font-size: 1.1rem;
        box-shadow: 0 6px 20px rgba(240, 87, 108, 0.3);
    }

    .btn-warning:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(240, 87, 108, 0.4);
    }

    .btn-warning:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .product-container {
            width: 100%;
            margin: 0 auto;
            padding: 15px 1rem;
        }

        h1 {
            font-size: 1.5rem;
        }

        .product-image {
            margin: 0 auto 20px auto;
            padding: 15px;
            min-height: 150px;
        }

        .radio-group {
            flex-direction: column;
            gap: 1rem;
        }

        .radio-group label {
            width: 100%;
            padding: 1rem;
        }

        .form-row {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .cup-options-grid {
            display: grid !important;
            grid-template-columns: 1fr !important;
            gap: 1rem;
        }

        .cup-option-card {
            width: 100%;
            min-height: 60px;
        }

        .price-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .total-row {
            font-size: 1.3rem;
            width: 100%;
            text-align: right;
            margin-top: 0;
            padding-top: 0.5rem;
        }

        .btn-warning {
            padding: 1rem 2rem;
            font-size: 1rem;
        }
    }
</style>

<div class="product-container">
    <!-- Header & Image -->
    <h1>Vertical Cuplock: {{ product.name }}</h1>
    
    <div class="product-image">
            <div class="product-image">
        <img src="{{ single_image_url }}" alt="{{ product.name }}" onerror="this.src='/static/images/no-image.png';">
    </div>
    </div>

    <!-- Available Sizes Info -->
    <div class="info-box">
        <strong>üí° Available Sizes:</strong>
        <p>Select from: 1m, 1.5m, 2m, 2.5m, 3m, 3.5m, 4m, 4.5m, 5m, 5.5m, 6m</p>
        <ul>
            <li><strong>Cup Options:</strong> Each size has multiple cup configurations available</li>
            <li><strong>Buy:</strong> One-time purchase (includes cup price)</li>
            <li><strong>Rent:</strong> Daily rental rate with refundable deposit</li>
        </ul>
    </div>

    <!-- Purchase Type Section -->
    <div class="purchase-type-section">
        <div class="radio-group">
            <input type="radio" id="buyOption" name="purchaseType" value="buy" checked onchange="updatePurchaseType()">
            <label for="buyOption">Buy (One-time Payment)</label>
            
            <input type="radio" id="rentOption" name="purchaseType" value="rent" onchange="updatePurchaseType()">
            <label for="rentOption">Rent (Per Day)</label>
        </div>
    </div>

    <!-- Size & Cup Options -->
    <div class="form-group">
        <label for="sizeSelect">Select Size *</label>
        <select id="sizeSelect" onchange="loadCups()">
            <option value="">-- Select Size --</option>
        </select>
    </div>

    <!-- Cup Options Grid -->
    <div id="cupSection" class="cup-options-grid">
        <p style="color:#666; padding: 2rem; text-align:center;">Please select a size first</p>
    </div>

    <!-- Quantity -->
    <div class="form-group">
        <label for="quantity">Quantity *</label>
        <input type="number" id="quantity" value="1" min="1" onchange="updatePrice()">
    </div>

    <!-- Price Display -->
    <div class="price-display">
        <div class="price-row">
            <span>Unit Price:</span>
            <span id="unitPrice">‚Çπ0.00</span>
        </div>
        <div class="price-row" id="depositRow" style="display:none">
            <span>Deposit (per unit):</span>
            <span id="depositAmount">‚Çπ0.00</span>
        </div>
        <div class="price-row total-row">
            <span>Total:</span>
            <span id="totalPrice">‚Çπ0.00</span>
        </div>
    </div>

    <!-- Add to Cart -->
    <button type="button" class="btn btn-warning" id="addToCartBtn" onclick="addToCart()">
        üõí Add to Cart
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('üîµ Vertical Cuplock page loaded');

const PRODUCT_ID = {{ product.id }};
const PRODUCT_BASE_PRICE = {{ product.price|default(0) }};

let selectedCupPrice = 0;
let rentPrice = 0;
let depositPrice = 0;
let selectedSizeLabel = null;
let selectedCupId = null;
let currentSizeBuyPrice = 0;

function loadSizes() {
    try {
        console.log('üîÑ Loading sizes...');
        
        const sizeSelect = document.getElementById('sizeSelect');
        if (!sizeSelect) {
            console.error('‚ùå Size select not found');
            return;
        }
        
        sizeSelect.innerHTML = '<option value="">Loading sizes...</option>';
        
        fetch('/cuplock/api/vertical/product/' + PRODUCT_ID + '/sizes')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to load sizes: ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Sizes loaded:', data);
                
                sizeSelect.innerHTML = '<option value="">-- Select Size --</option>';
                
                if (!data.success || !data.sizes || data.sizes.length === 0) {
                    sizeSelect.innerHTML += '<option value="" disabled>No sizes available</option>';
                    console.warn('‚ö†Ô∏è No sizes returned from API');
                    return;
                }
                
                data.sizes.forEach(function(size) {
                    const option = document.createElement('option');
                    option.value = size.id;
                    option.textContent = size.size_label;
                    option.setAttribute('data-label', size.size_label);
                    option.setAttribute('data-buy', size.buy_price);
                    option.setAttribute('data-rent', size.rent_price);
                    option.setAttribute('data-deposit', size.deposit);
                    sizeSelect.appendChild(option);
                });
                
                console.log('‚úÖ Added', data.sizes.length, 'sizes to dropdown');
            })
            .catch(function(error) {
                console.error('‚ùå Error loading sizes:', error);
                sizeSelect.innerHTML = '<option value="" disabled>Error loading sizes. Please refresh.</option>';
            });
    } catch (error) {
        console.error('‚ùå Error in loadSizes:', error);
    }
}

function updatePurchaseType() {
    try {
        const isBuy = document.getElementById('buyOption').checked;
        const cupSection = document.getElementById('cupSection');
        
        console.log('üìä Purchase type:', isBuy ? 'buy' : 'rent');
        
        cupSection.style.display = isBuy ? 'grid' : 'none';
        
        if (!isBuy) {
            selectedCupPrice = 0;
            selectedCupId = null;
            const cards = document.querySelectorAll('.cup-option-card');
            cards.forEach(function(card) {
                card.classList.remove('selected');
            });
        }
        
        updatePrice();
    } catch (error) {
        console.error('‚ùå Error in updatePurchaseType:', error);
    }
}

// ============================================================================
// FIXED loadCups() FUNCTION for cuplock_vertical.html
// Replace your existing loadCups function with this:
// ============================================================================

function loadCups() {
    try {
        console.log('üîÑ Loading cups...');
        
        const sizeSelect = document.getElementById('sizeSelect');
        const container = document.getElementById('cupSection');
        
        if (!sizeSelect || !container) {
            console.error('‚ùå Required elements not found');
            return;
        }
        
        const selectedIndex = sizeSelect.selectedIndex;
        if (selectedIndex <= 0) {
            selectedCupPrice = 0;
            selectedCupId = null;
            selectedSizeLabel = null;
            container.innerHTML = '<p style="color:#666; text-align:center; padding: 2rem;">Please select a size first</p>';
            updatePrice();
            return;
        }

        const selectedOption = sizeSelect.options[selectedIndex];
        const sizeId = selectedOption.value;
        selectedSizeLabel = selectedOption.getAttribute('data-label') || '';

        rentPrice = parseFloat(selectedOption.getAttribute('data-rent')) || 0;
        depositPrice = parseFloat(selectedOption.getAttribute('data-deposit')) || 0;
        currentSizeBuyPrice = parseFloat(selectedOption.getAttribute('data-buy')) || 0;

        console.log('üìä Size selected:', {
            sizeId: sizeId,
            label: selectedSizeLabel,
            buy: currentSizeBuyPrice,
            rent: rentPrice,
            deposit: depositPrice
        });

        container.innerHTML = '<p style="text-align:center;">Loading cup options...</p>';

        // ‚úÖ FIXED: Proper URL construction with error handling
        const cupsUrl = '/cuplock/api/vertical/size/' + encodeURIComponent(sizeId) + '/cups';
        console.log('üåê Fetching cups from:', cupsUrl);

        fetch(cupsUrl)
            .then(function(response) {
                console.log('üì° Response status:', response.status);
                
                // ‚úÖ Handle different response codes
                if (response.status === 404) {
                    console.error('‚ùå 404 Error: Cups endpoint not found');
                    throw new Error('Cups endpoint not found. Please check cuplock_routes.py');
                }
                
                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }
                
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Cups loaded:', data);
                
                container.innerHTML = '';
                selectedCupPrice = 0;
                selectedCupId = null;

                // ‚úÖ Check if response is successful
                if (!data.success) {
                    container.innerHTML = '<p style="color:#ff6b6b; text-align:center; padding: 2rem;">Error loading cups: ' + (data.message || 'Unknown error') + '</p>';
                    updatePrice();
                    return;
                }

                // ‚úÖ Check if cups array exists and has items
                if (!data.cups || data.cups.length === 0) {
                    container.innerHTML = '<p style="color:#666; text-align:center; padding: 2rem;">No cup options available for this size.</p>';
                    updatePrice();
                    return;
                }

                // ‚úÖ Create cup cards
                data.cups.forEach(function(c) {
                    const card = document.createElement('div');
                    card.className = 'cup-option-card';

                    const cupPrice = c.price || 0;
                    const cupCount = c.cup_count || 0;

                    card.innerHTML = '<div>' + cupCount + (cupCount === 1 ? ' Cup' : ' Cups') + '</div>' +
                                   '<div style="font-size:0.9rem; color:#666; margin-top:0.5rem;">+‚Çπ' + cupPrice.toFixed(2) + '</div>';
                    card.dataset.price = cupPrice;
                    card.dataset.cupId = c.id;

                    card.addEventListener('click', function() {
                        selectedCupPrice = parseFloat(this.dataset.price);
                        selectedCupId = this.dataset.cupId;

                        console.log('üéØ Cup selected:', cupCount, 'Price:', selectedCupPrice);

                        document.querySelectorAll('.cup-option-card').forEach(function(el) {
                            el.classList.remove('selected');
                        });
                        card.classList.add('selected');

                        updatePrice();
                    });

                    container.appendChild(card);
                });

                updatePrice();
            })
            .catch(function(error) {
                console.error('‚ùå Error loading cups:', error);
                
                // ‚úÖ User-friendly error message
                let errorMsg = 'Error loading cups. ';
                
                if (error.message.includes('404') || error.message.includes('not found')) {
                    errorMsg += 'Please check if the cups API route exists in cuplock_routes.py';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'Network error. Please check if server is running.';
                } else {
                    errorMsg += error.message;
                }
                
                container.innerHTML = '<p style="color: red; text-align:center; padding:2rem;">' + errorMsg + '</p>';
                updatePrice();
            });
    } catch (error) {
        console.error('‚ùå Error in loadCups:', error);
    }
}


// ============================================================================
// DEBUGGING TIPS:
// ============================================================================

// 1. Open browser console (F12)
// 2. Select a size from dropdown
// 3. Watch console logs:
//    - "Loading cups..." should appear
//    - "Fetching cups from: /cuplock/api/vertical/size/XX/cups" should show
//    - "Response status: 200" or "404" will tell you if route exists
//    - "Cups loaded: {success: true, cups: [...]}" if successful

// 4. If you see 404:
//    - Check cuplock_routes.py has the api_vertical_size_cups route
//    - Check app.py has: app.register_blueprint(cuplock_bp, url_prefix='/cuplock')
//    - Restart Flask server

// 5. If you see 200 but no cups:
//    - Check the console log to see what data was returned
//    - Visit: http://127.0.0.1:5001/cuplock/debug/vertical/size/YOUR_SIZE_ID/cups
//    - This will show if cups exist in database

// ============================================================================

function updatePrice() {
    try {
        const qtyInput = document.getElementById('quantity');
        const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
        
        const isBuy = document.getElementById('buyOption').checked;
        
        let unit = 0;
        let deposit = 0;

        if (isBuy) {
            unit = currentSizeBuyPrice + selectedCupPrice;
        } else {
            unit = rentPrice;
            deposit = depositPrice;
        }

        const total = (unit * qty) + (deposit * qty);

        console.log('üí∞ Price calculated:', {
            type: isBuy ? 'buy' : 'rent',
            unit: unit,
            deposit: deposit,
            qty: qty,
            total: total
        });

        const unitPriceEl = document.getElementById('unitPrice');
        const depositAmountEl = document.getElementById('depositAmount');
        const totalPriceEl = document.getElementById('totalPrice');
        const depositRowEl = document.getElementById('depositRow');

        if (unitPriceEl) unitPriceEl.innerText = '‚Çπ' + unit.toFixed(2);
        if (depositAmountEl) depositAmountEl.innerText = '‚Çπ' + deposit.toFixed(2);
        if (totalPriceEl) totalPriceEl.innerText = '‚Çπ' + total.toFixed(2);
        if (depositRowEl) {
            depositRowEl.style.display = (!isBuy && deposit > 0) ? 'flex' : 'none';
        }
    } catch (error) {
        console.error('‚ùå Error in updatePrice:', error);
    }
}

function addToCart() {
    try {
        const qtyInput = document.getElementById('quantity');
        const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
        const isBuy = document.getElementById('buyOption').checked;
        const type = isBuy ? 'buy' : 'rent';

        if (!selectedSizeLabel) {
            alert("‚ö†Ô∏è Please select a size");
            return;
        }

        if (isBuy && !selectedCupId) {
            alert("‚ö†Ô∏è Please select a cup configuration");
            return;
        }

        const customization = {
            component: "vertical",
            purchase_type: type,
            size: selectedSizeLabel,
            cup_id: selectedCupId,
            cup_price: selectedCupPrice
        };

        console.log('üõí Adding to cart:', customization);

        const btn = document.getElementById('addToCartBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Adding...';

        fetch('/add_to_cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product_id: PRODUCT_ID,
                quantity: qty,
                customization: customization
            })
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                console.log('‚úÖ Added to cart successfully');
                window.location.href = '/cart';
            } else {
                alert('‚ùå ' + (data.message || 'Failed to add to cart'));
                btn.disabled = false;
                btn.innerHTML = 'üõí Add to Cart';
            }
        })
        .catch(function(error) {
            console.error('‚ùå Error:', error);
            alert('‚ùå Error adding to cart. Please try again.');
            btn.disabled = false;
            btn.innerHTML = 'üõí Add to Cart';
        });
    } catch (error) {
        console.error('‚ùå Error in addToCart:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ Page ready, loading sizes...');
    loadSizes();
    updatePurchaseType();
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Vertical Cuplock - {{ product.name }}{% endblock %}

{% block content %}
<style>
.product-container {
    max-width: 900px;
    margin: 20px auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.purchase-type-section {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.purchase-type-section label {
    margin-right: 20px;
    cursor: pointer;
    font-weight: 600;
}

.form-group {
    margin: 20px 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}

.cup-images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.cup-image-card {
    border: 3px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.cup-image-card:hover {
    border-color: #007bff;
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.2);
}

.cup-image-card.selected {
    border-color: #28a745;
    background: #e8f5e9;
}

.cup-image-card img {
    width: 100%;
    height: 120px;
    object-fit: contain;
    margin-bottom: 10px;
}

.cup-price {
    font-weight: bold;
    color: #28a745;
    font-size: 18px;
}

.price-display {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

.price-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    font-size: 18px;
}

.total-row {
    border-top: 2px solid rgba(255,255,255,0.3);
    margin-top: 10px;
    padding-top: 15px;
    font-weight: bold;
    font-size: 24px;
}

.btn {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245,87,108,0.4);
}

.info-box {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin: 20px 0;
    border-radius: 5px;
}
</style>

<div class="product-container">
    <h1>{{ product.name }}</h1>
    <p>{{ product.description }}</p>

    <!-- PRODUCT IMAGE -->
    <div style="text-align:center;margin-bottom:20px;">
        <img src="{{ url_for('static', filename=product.display_image_url) }}"
             style="max-width:300px;border-radius:8px;"
             onerror="this.src='{{ url_for('static', filename='images/no-image.png') }}'">
    </div>

    <!-- Available Sizes Info -->
    <div class="info-box">
        <h4 style="margin-top:0;">Available Sizes:</h4>
        <p>1m, 1.5m, 2m, 2.5m, 3m</p>
        
        <h4>Cup Options by Size:</h4>
        <ul>
            <li><strong>1m:</strong> 1 or 2 cups</li>
            <li><strong>1.5m:</strong> 2 or 3 cups</li>
            <li><strong>2m:</strong> 2, 3, or 4 cups</li>
            <li><strong>2.5m:</strong> 2, 3, or 4 cups</li>
            <li><strong>3m:</strong> 3, 4, or 6 cups</li>
        </ul>
    </div>

    <!-- PURCHASE TYPE -->
    <div class="purchase-type-section">
        <label>
            <input type="radio" name="purchaseType" value="buy" checked onchange="updatePurchaseType()">
            Buy
        </label>
        <label>
            <input type="radio" name="purchaseType" value="rent" onchange="updatePurchaseType()">
            Rent (per day)
        </label>
    </div>

    <!-- SIZE -->
    <div class="form-group">
        <label>Select Size *</label>
        <select id="sizeSelect" onchange="loadCups()">
            <option value="">-- Select Size --</option>
            {% for size in sizes %}
            <option
                value="{{ size.id }}"
                data-label="{{ size.size_label }}"
                data-rent="{{ size.rent_price }}"
                data-deposit="{{ size.deposit }}">
                {{ size.size_label }}
            </option>
            {% endfor %}
        </select>
    </div>

    <!-- CUP SECTION -->
    <div id="cupSection" style="display:block;">
        <h3>Select Cup Configuration *</h3>
        <div id="cupImagesContainer" class="cup-images-grid">
            <p style="color:#666;">Please select a size first</p>
        </div>
    </div>

    <!-- QUANTITY -->
    <div class="form-group">
        <label>Quantity *</label>
        <input type="number" id="quantity" value="1" min="1" onchange="updatePrice()">
    </div>

    <!-- PRICE -->
    <div class="price-display">
        <div class="price-row">
            <span>Unit Price:</span>
            <span id="unitPrice">‚Çπ0.00</span>
        </div>

        <div class="price-row" id="depositRow" style="display:none">
            <span>Deposit (per unit):</span>
            <span id="depositAmount">‚Çπ0.00</span>
        </div>

        <div class="price-row total-row">
            <span>Total:</span>
            <span id="totalPrice">‚Çπ0.00</span>
        </div>
    </div>

    <!-- ADD TO CART -->
    <button type="button" class="btn btn-warning" onclick="addToCart()">
        üõí Add to Cart
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
// ============================================
// VERTICAL CUPLOCK PRODUCT PAGE LOGIC
// ============================================

console.log('üîµ Vertical Cuplock page loaded');

/* ================== GLOBALS ================== */
const PRODUCT_ID = {{ product.id }};
const PRODUCT_BASE_PRICE = {{ product.price|default(0) }};

let selectedCupPrice = 0;
let rentPrice = 0;
let depositPrice = 0;
let selectedSizeLabel = null;
let selectedCupId = null;

/* ================== PURCHASE TYPE ================== */
function updatePurchaseType() {
    try {
        const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
        const cupSection = document.getElementById('cupSection');
        
        if (!purchaseTypeRadios || !cupSection) {
            console.error('Required elements not found');
            return;
        }
        
        let isBuySelected = false;
        purchaseTypeRadios.forEach(function(radio) {
            if (radio.checked && radio.value === 'buy') {
                isBuySelected = true;
            }
        });
        
        // Show/hide cup section based on purchase type
        cupSection.style.display = isBuySelected ? 'block' : 'none';
        
        // Reset cup selection when switching to rent
        if (!isBuySelected) {
            selectedCupPrice = 0;
            selectedCupId = null;
            document.querySelectorAll('.cup-image-card').forEach(function(card) {
                card.classList.remove('selected');
            });
        }
        
        updatePrice();
    } catch (error) {
        console.error('Error in updatePurchaseType:', error);
    }
}

/* ================== LOAD CUP OPTIONS ================== */
function loadCups() {
    try {
        console.log('üîÑ loadCups() called');
        
        const sizeSelect = document.getElementById('sizeSelect');
        const container = document.getElementById('cupImagesContainer');
        
        if (!sizeSelect || !container) {
            console.error('Required elements not found');
            return;
        }
        
        const selectedOption = sizeSelect.options[sizeSelect.selectedIndex];

        // Clear selections if no option selected
        if (!selectedOption || !selectedOption.value) {
            selectedCupPrice = 0;
            selectedCupId = null;
            selectedSizeLabel = null;
            rentPrice = 0;
            depositPrice = 0;
            container.innerHTML = '<p style="color:#666;">Please select a size first</p>';
            updatePrice();
            return;
        }

        const sizeId = selectedOption.value;
        selectedSizeLabel = selectedOption.getAttribute('data-label') || '';

        // Get rent and deposit prices
        const rentValue = selectedOption.getAttribute('data-rent');
        const depositValue = selectedOption.getAttribute('data-deposit');
        
        rentPrice = rentValue ? parseFloat(rentValue) : 0;
        depositPrice = depositValue ? parseFloat(depositValue) : 0;

        console.log('üìä Selected size:', selectedSizeLabel, 'Rent:', rentPrice, 'Deposit:', depositPrice);

        // Show loading
        container.innerHTML = '<p>Loading cup options...</p>';

        // Fetch cups for this size
        fetch('/cuplock/api/vertical/size/' + encodeURIComponent(sizeId) + '/cups')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Cups loaded:', data);
                
                container.innerHTML = '';
                selectedCupPrice = 0;
                selectedCupId = null;

                if (!data.success || !data.cups || data.cups.length === 0) {
                    container.innerHTML = '<p style="color:#ff6b6b;">No cup options available for this size</p>';
                    updatePrice();
                    return;
                }

                const cups = data.cups;
                cups.forEach(function(c) {
                    const card = document.createElement('div');
                    card.className = 'cup-image-card';

                    // ‚úÖ FIXED: Handle image URL properly
                    let imageUrl = c.image_url || 'images/no-image.png';
                    
                    // Build the correct URL for static files
                    // Backend returns: "uploads/filename.png"
                    // We need: "/static/uploads/filename.png"
                    if (imageUrl && !imageUrl.startsWith('/static/') && !imageUrl.startsWith('http')) {
                        // If it starts with 'uploads/', use it as-is
                        // Otherwise, add 'uploads/' prefix
                        if (!imageUrl.startsWith('uploads/')) {
                            imageUrl = 'uploads/' + imageUrl;
                        }
                        // Now prepend /static/
                        imageUrl = '/static/' + imageUrl;
                    }
                    
                    console.log('üñºÔ∏è Cup image URL:', imageUrl);

                    card.innerHTML = 
                        '<img src="' + imageUrl + '" onerror="this.src=\'/static/images/no-image.png\'" alt="' + c.cup_count + ' cups">' +
                        '<p><strong>' + c.cup_count + ' Cups</strong></p>' +
                        '<p class="cup-price">‚Çπ' + (c.buy_price || 0).toFixed(2) + '</p>';

                    // Add click handler
                    card.addEventListener('click', function() {
                        selectedCupPrice = parseFloat(c.buy_price || 0);
                        selectedCupId = c.id;

                        console.log('üéØ Selected cup:', c.cup_count, 'cups, Price:', selectedCupPrice);

                        // Remove selected class from all cards
                        document.querySelectorAll('.cup-image-card').forEach(function(el) {
                            el.classList.remove('selected');
                        });
                        card.classList.add('selected');

                        updatePrice();
                    });

                    container.appendChild(card);
                });

                updatePrice();
            })
            .catch(function(error) {
                console.error('‚ùå Error loading cups:', error);
                container.innerHTML = '<p style="color: red;">Error loading cup options. Please try again.</p>';
                updatePrice();
            });
    } catch (error) {
        console.error('‚ùå Error in loadCups:', error);
    }
}
/* ================== PRICE PREVIEW ================== */
function updatePrice() {
    try {
        const qtyInput = document.getElementById('quantity');
        const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
        
        // Get quantity
        const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
        
        // Get purchase type
        let type = 'buy';
        if (purchaseTypeRadios) {
            purchaseTypeRadios.forEach(function(radio) {
                if (radio.checked && radio.value === 'rent') {
                    type = 'rent';
                }
            });
        }

        let unit = 0;
        let deposit = 0;

        if (type === 'buy') {
            // Buy = base price + selected cup price
            unit = PRODUCT_BASE_PRICE + selectedCupPrice;
        } else {
            // Rent = rent price + deposit
            unit = rentPrice;
            deposit = depositPrice;
        }

        const total = (unit * qty) + (deposit * qty);

        console.log('üí∞ Price updated - Type:', type, 'Unit:', unit, 'Deposit:', deposit, 'Total:', total);

        // Update display
        const unitPriceEl = document.getElementById('unitPrice');
        const depositAmountEl = document.getElementById('depositAmount');
        const totalPriceEl = document.getElementById('totalPrice');
        const depositRowEl = document.getElementById('depositRow');

        if (unitPriceEl) unitPriceEl.innerText = '‚Çπ' + unit.toFixed(2);
        if (depositAmountEl) depositAmountEl.innerText = '‚Çπ' + deposit.toFixed(2);
        if (totalPriceEl) totalPriceEl.innerText = '‚Çπ' + total.toFixed(2);
        if (depositRowEl) {
            depositRowEl.style.display = (type === 'rent' && deposit > 0) ? 'flex' : 'none';
        }
    } catch (error) {
        console.error('‚ùå Error in updatePrice:', error);
    }
}

/* ================== ADD TO CART ================== */
function addToCart() {
    try {
        const qtyInput = document.getElementById('quantity');
        const purchaseTypeRadios = document.querySelectorAll('input[name="purchaseType"]');
        
        const qty = qtyInput ? (parseInt(qtyInput.value) || 1) : 1;
        
        // Get purchase type
        let type = 'buy';
        if (purchaseTypeRadios) {
            purchaseTypeRadios.forEach(function(radio) {
                if (radio.checked && radio.value === 'rent') {
                    type = 'rent';
                }
            });
        }

        // Validation
        if (!selectedSizeLabel) {
            alert("‚ö†Ô∏è Please select a size");
            return;
        }

        if (type === 'buy' && !selectedCupId) {
            alert("‚ö†Ô∏è Please select a cup configuration");
            return;
        }

        // ‚úÖ CRITICAL: Include the selected cup price in customization
        const customization = {
            component: "vertical",
            purchase_type: type,
            size: selectedSizeLabel,
            cup_id: selectedCupId,
            cup_price: selectedCupPrice  // ‚Üê ADD THIS!
        };

        console.log('üõí Adding to cart:', customization);

        // Disable button
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Adding...';

        fetch('/add_to_cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product_id: PRODUCT_ID,
                quantity: qty,
                customization: customization
            })
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                console.log('‚úÖ Added to cart successfully');
                window.location.href = '/cart';
            } else {
                alert('‚ùå ' + (data.message || 'Failed to add to cart'));
                btn.disabled = false;
                btn.textContent = 'üõí Add to Cart';
            }
        })
        .catch(function(error) {
            console.error('‚ùå Error:', error);
            alert('‚ùå Error adding to cart. Please try again.');
            btn.disabled = false;
            btn.textContent = 'üõí Add to Cart';
        });
    } catch (error) {
        console.error('‚ùå Error in addToCart:', error);
    }
}

// Initialize on page load
try {
    updatePurchaseType();
    updatePrice();
    console.log('‚úÖ Page initialized successfully');
} catch (error) {
    console.error('‚ùå Error during initialization:', error);
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Admin - Scaffolding Products{% endblock %}

{% block content %}
<div class="glass-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <button class="btn-primary" onclick="window.location.href='{{ url_for('admin_analytics') }}'" style="width: auto; background: linear-gradient(135deg, #4CAF50, #45a049);">üìä Business Analytics</button>
        <div style="display: flex; gap: 1rem;">
            <button class="btn-primary" onclick="window.location.href='{{ url_for('admin_orders') }}'" style="width: auto; background: linear-gradient(135deg, #9333ea, #7928ca);">üìã View All Orders</button>
            <button class="btn-danger" onclick="window.location.href='{{ url_for('admin_logout') }}'" style="width: auto;">Logout</button>
        </div>
    </div>
    <h1 class="page-title">Admin Panel - Scaffolding Products</h1>
    
    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="btn-primary" onclick="showAddModal()" style="width: auto;">
            + Add New Product
        </button>
        <button class="btn-primary" onclick="window.location.href='{{ url_for('admin_aluminium_pricing') }}'" style="width: auto; background: linear-gradient(135deg, #d4af37, #c29d2f);">
            üí∞ Manage Aluminium Pricing
        </button>
        <button class="btn-primary" onclick="window.location.href='{{ url_for('admin_hframes_pricing') }}'" style="width: auto; background: linear-gradient(135deg, #d4af37, #c29d2f);">
            üí∞ Manage H-Frames Pricing
        </button>
        <button class="btn-primary" onclick="window.location.href='{{ url_for('admin_accessories_pricing') }}'" style="width: auto; background: linear-gradient(135deg, #d4af37, #c29d2f);">
            üí∞ Manage Accessories Pricing
        </button>
    </div>
    
    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Category</th>
                <th>Rent Price</th>
                <th>Deposit</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>{{ product.id }}</td>
                <td>{{ product.name }}</td>
                <td>‚Çπ{{ product.price }}</td>
                <td>{{ product.category|title if product.category else 'N/A' }}</td>
                <td>‚Çπ{{ product.rent_price if product.rent_price else 'N/A' }}</td>
                <td>‚Çπ{{ product.deposit_amount if product.deposit_amount else 'N/A' }}</td>
                <td>
                    <button class="btn-secondary" onclick="editProduct({{ product.id }}, '{{ product.name }}', {{ product.price }}, '{{ product.description }}', '{{ product.category }}', {{ product.rent_price if product.rent_price else 0 }}, {{ product.weight_per_unit if product.weight_per_unit else 0 }}, {{ product.deposit_amount if product.deposit_amount else 0 }}, '{{ product.image_url if product.image_url else '' }}')" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">Edit</button>
                    <button class="btn-danger" onclick="deleteProduct({{ product.id }})">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="productModal" class="modal">
    <div class="modal-content">
        <h2 style="color: #ffa500; margin-bottom: 1.5rem;" id="modalTitle">Add Product</h2>
        <form id="productForm">
            <input type="hidden" id="productId">
            <div class="form-group">
                <label for="productName">Product Name</label>
                <input type="text" id="productName" required>
            </div>
            <div class="form-group">
                <label for="productPrice">Price (‚Çπ)</label>
                <input type="number" id="productPrice" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="productRentPrice">Rent Price (‚Çπ/month)</label>
                <input type="number" id="productRentPrice" step="0.01">
            </div>
            <div class="form-group">
                <label for="productDeposit">Deposit Amount (‚Çπ)</label>
                <input type="number" id="productDeposit" step="0.01">
                <small style="color: #888; font-size: 0.85rem; display: block; margin-top: 0.5rem;">Deposit required when renting this product</small>
            </div>
            <div class="form-group">
                <label for="productCategory">Category</label>
                <select id="productCategory" required onchange="updateCategoryFields()">
                    <option value="aluminium">Aluminium</option>
                    <option value="h-frames">H-Frames</option>
                    <option value="cuplock">Cuplock</option>
                    <option value="accessories">Accessories</option>
                </select>
            </div>
            <div class="form-group">
                <label for="productDescription">Description</label>
                <textarea id="productDescription" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="productImage">Product Image (All image types supported)</label>
                <input type="file" id="productImage" accept="image/*,.bmp,.svg,.tiff,.tif,.ico,.jfif,.pjpeg,.pjp,.avif,.heic,.heif" capture="environment" style="padding: 0.75rem; background: rgba(255, 255, 255, 0.95); border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 8px; color: #001d3d; width: 100%;">
                <small style="color: #888; font-size: 0.85rem; display: block; margin-top: 0.5rem;">Upload any image type (PNG, JPG, GIF, WebP, BMP, SVG, TIFF, HEIC, etc.) from your device or camera</small>
                <div id="imagePreview" style="margin-top: 1rem; display: none; position: relative;">
                    <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #ffa500; display: block;">
                    <button type="button" onclick="removePhoto()" style="position: absolute; top: -10px; right: 10px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">√ó</button>
                </div>
            </div>
            <div class="form-group" id="weightField" style="display: none;">
                <label for="productWeight">Weight per Unit (kg) - For Cuplock pricing</label>
                <input type="number" id="productWeight" step="0.1" placeholder="Default: 5 kg">
            </div>
            
            <!-- Category-Specific Fields Section -->
            <div id="categorySpecificSection"></div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn-primary">Save</button>
                <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
let editMode = false;

function updateCategoryFields() {
    const category = document.getElementById('productCategory').value;
    const rentField = document.getElementById('productRentPrice').closest('.form-group');
    const priceField = document.getElementById('productPrice').closest('.form-group');
    const depositField = document.getElementById('productDeposit').closest('.form-group');
    const priceInput = document.getElementById('productPrice');
    const rentPriceInput = document.getElementById('productRentPrice');
    const depositInput = document.getElementById('productDeposit');
    const weightField = document.getElementById('weightField');
    const categorySection = document.getElementById('categorySpecificSection');
    
    // For Cuplock: Hide Price, Rent Price, Deposit and Weight fields - Only show Name, Description, and Images
    if (category === 'cuplock') {
        priceField.style.display = 'none';
        rentField.style.display = 'none';
        depositField.style.display = 'none';
        weightField.style.display = 'none';
        // Remove required attribute and set default value for Cuplock
        priceInput.removeAttribute('required');
        priceInput.value = '0';
        rentPriceInput.value = '0';
        depositInput.value = '0';
    } else {
        priceField.style.display = 'block';
        rentField.style.display = 'block';
        depositField.style.display = 'block';
        weightField.style.display = 'none';
        // Re-add required attribute for other categories
        priceInput.setAttribute('required', 'required');
    }
    
    // Add category-specific fields
    let categoryHTML = '';
    
    if (category === 'aluminium') {
        categoryHTML = `
            <div class="category-specific-fields">
                <h3>‚öôÔ∏è Aluminium Scaffolding Options</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hasPricingMatrix" style="width: auto; margin-right: 0.5rem;">
                        This product has a Pricing Matrix (different prices for width/height combinations)
                    </label>
                    <small>Check this if the product needs custom prices for 0.7m/1.4m widths and 2m-16m heights</small>
                </div>
                <div class="form-group">
                    <label for="aluminiumNotes">Dimension Notes</label>
                    <textarea id="aluminiumNotes" rows="2" placeholder="e.g., Available in single width (0.7m) and double width (1.4m)"></textarea>
                </div>
            </div>
        `;
    } else if (category === 'h-frames') {
        categoryHTML = `
            <div class="category-specific-fields">
                <h3>üîß H-Frame Options</h3>
                <div class="form-group">
                    <label for="hframeHeight">Standard Height</label>
                    <select id="hframeHeight">
                        <option value="">Select Height</option>
                        <option value="1.8m">1.8m</option>
                        <option value="2.0m">2.0m</option>
                        <option value="2.5m">2.5m</option>
                        <option value="3.0m">3.0m</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hasQuantityDiscount" style="width: auto; margin-right: 0.5rem;">
                        Quantity-based Discounts (e.g., 10%, 15%, 20% for bulk orders)
                    </label>
                </div>
            </div>
        `;
    } else if (category === 'cuplock') {
        // Cuplock: No additional fields - Only Product Name, Description, and Multiple Images
        categoryHTML = '';
    } else if (category === 'accessories') {
        categoryHTML = `
            <div class="category-specific-fields">
                <h3>üõ†Ô∏è Accessory Details</h3>
                <div class="form-group">
                    <label for="accessoryMaterial">Material</label>
                    <select id="accessoryMaterial">
                        <option value="">Select Material</option>
                        <option value="steel">Steel</option>
                        <option value="aluminum">Aluminum</option>
                        <option value="plastic">Plastic</option>
                        <option value="composite">Composite</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="compatibility">Compatible With</label>
                    <textarea id="compatibility" rows="2" placeholder="e.g., All scaffolding types, Aluminium only, H-Frames only"></textarea>
                </div>
            </div>
        `;
    }
    
    categorySection.innerHTML = categoryHTML;
}

function showAddModal() {
    editMode = false;
    document.getElementById('modalTitle').textContent = 'Add Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModal').classList.add('show');
    updateCategoryFields();
}

function editProduct(id, name, price, description, category, rentPrice, weight, deposit, imageUrl) {
    editMode = true;
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('productId').value = id;
    document.getElementById('productName').value = name;
    document.getElementById('productPrice').value = price;
    document.getElementById('productRentPrice').value = rentPrice || '';
    document.getElementById('productDeposit').value = deposit || '';
    document.getElementById('productCategory').value = category;
    document.getElementById('productDescription').value = description;
    document.getElementById('productWeight').value = weight || '';
    
    if (imageUrl) {
        document.getElementById('previewImg').src = imageUrl;
        document.getElementById('imagePreview').style.display = 'block';
    } else {
        document.getElementById('imagePreview').style.display = 'none';
    }
    
    document.getElementById('productModal').classList.add('show');
    updateCategoryFields();
}

function closeModal() {
    document.getElementById('productModal').classList.remove('show');
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('productImage').value = '';
}

function removePhoto() {
    const productId = document.getElementById('productId').value;
    
    if (editMode && productId && confirm('Are you sure you want to remove this photo?')) {
        fetch('/admin_remove_photo/' + productId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('productImage').value = '';
                alert('Photo removed successfully!');
            } else {
                alert('Error removing photo');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    } else {
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('productImage').value = '';
    }
}

function deleteProduct(id) {
    if (confirm('Are you sure you want to delete this product?')) {
        fetch('/admin_delete_product/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Product deleted successfully!');
                location.reload();
            }
        });
    }
}

document.getElementById('productImage').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formDataObj = new FormData();
    formDataObj.append('name', document.getElementById('productName').value);
    formDataObj.append('price', document.getElementById('productPrice').value);
    formDataObj.append('rent_price', document.getElementById('productRentPrice').value || '');
    formDataObj.append('deposit_amount', document.getElementById('productDeposit').value || '');
    formDataObj.append('category', document.getElementById('productCategory').value);
    formDataObj.append('description', document.getElementById('productDescription').value);
    formDataObj.append('weight_per_unit', document.getElementById('productWeight').value || '');
    formDataObj.append('product_type', 'scaffolding');
    
    const imageFile = document.getElementById('productImage').files[0];
    if (imageFile) {
        formDataObj.append('product_image', imageFile);
    }
    
    const url = editMode ? 
        '/admin_update_product/' + document.getElementById('productId').value :
        '/admin_add_product';
    
    fetch(url, {
        method: 'POST',
        body: formDataObj
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(editMode ? 'Product updated successfully!' : 'Product added successfully!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
});
{% endblock %}

{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="glass-container">
    <button class="btn-secondary"
            onclick="window.location.href='{{ url_for('cart') }}'"
            style="margin-bottom: 1rem;">
        ← Back to Cart
    </button>

    <h1 class="page-title">Checkout</h1>

    <div class="qr-container">

        <!-- PAYMENT SUMMARY -->
        <h2 style="color:#ffa500;margin-bottom:1rem;">Payment Summary</h2>

        <div style="background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:10px;">
            <div class="row-between">
                <span>Subtotal:</span>
                <span>₹{{ "%.2f"|format(total) }}</span>
            </div>

            <div class="row-between">
                <span>GST (18%):</span>
                <span>₹{{ "%.2f"|format(gst) }}</span>
            </div>

            {% if total_deposit and total_deposit > 0 %}
            <div class="row-between" style="color:#d4af37;">
                <span>Rental Deposit:</span>
                <span>₹{{ "%.2f"|format(total_deposit) }}</span>
            </div>
            {% endif %}

            <hr>
            <div class="row-between total">
                <span>Total Amount:</span>
                <span>₹{{ "%.2f"|format(total_with_gst) }}</span>
            </div>
        </div>

        <p style="margin-top:1rem;">
            Payment Time Limit:
            <strong id="payment-timer">15:00</strong>
        </p>

        <p>Scan the QR code below and pay the exact amount.</p>

        <!-- QR -->
        <div style="text-align:center;margin:2rem 0;">
            <img src="{{ url_for('static', filename='phonepe_qr.png') }}"
                 width="300" height="300">
        </div>

        <h2 style="color:#4CAF50;">Pay ₹{{ "%.2f"|format(total_with_gst) }}</h2>

        <!-- TRANSACTION INPUT -->
        <h3 style="color:#ffa500;margin-top:2rem;">Confirm Payment</h3>
        <p>Enter your UPI Transaction ID after payment:</p>

        <div class="form-group">
            <label>UPI Transaction ID</label>
            <input type="text"
                   id="transaction_id"
                   placeholder="Enter transaction ID"
                   oninput="validateUPIID()">
        </div>

        <!-- ACTION BUTTONS -->
        <div class="actions">
            <button id="payment_btn"
                    class="btn-primary"
                    onclick="completeOrder()"
                    disabled>
                Confirm Payment & Complete Order
            </button>

            <button class="btn-secondary"
                    onclick="window.location.href='{{ url_for('cart') }}'">
                Back to Cart
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ===========================
   TIMER
=========================== */
let timeLeft = 900;
const timerEl = document.getElementById("payment-timer");

const timer = setInterval(() => {
    if (timeLeft <= 0) {
        timerEl.textContent = "00:00";
        document.getElementById("payment_btn").disabled = true;
        clearInterval(timer);
        return;
    }
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    timeLeft--;
}, 1000);

/* ===========================
   VALIDATE UPI ID
=========================== */
function validateUPIID() {
    const val = document.getElementById("transaction_id").value.trim();
    const btn = document.getElementById("payment_btn");

    const valid =
        val.length >= 12 &&
        val.length <= 35 &&
        /^[a-zA-Z0-9]+$/.test(val);

    btn.disabled = !valid;
}

/* ===========================
   COMPLETE ORDER (FIXED)
=========================== */
function completeOrder() {
    const transactionId = document.getElementById("transaction_id").value.trim();
    const btn = document.getElementById("payment_btn");

    if (!transactionId) {
        alert("Please enter transaction ID");
        return;
    }

    btn.disabled = true;
    btn.textContent = "Processing...";

    fetch('/complete_order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            transaction_id: transactionId
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || "Payment failed");
        }

        alert(
            "Order submitted successfully!\n\n" +
            "Transaction ID: " + transactionId + "\n" +
            "Status: Pending admin verification"
        );

        window.location.href = "{{ url_for('my_orders') }}";
    })
    .catch(err => {
        alert(err.message);
        btn.disabled = false;
        btn.textContent = "Confirm Payment & Complete Order";
    });
}
</script>

{% endblock %}

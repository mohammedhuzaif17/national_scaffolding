{% extends "base.html" %}

{% block title %}Add New Scaffolding Product - Admin{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <h1>Add New Scaffolding Product</h1>
        <a href="{{ url_for('admin_scaffoldings') }}" class="btn btn-secondary">‚Üê Back to Admin</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <!-- The action attribute is crucial. It tells the form where to submit the data. -->
        <form method="POST" action="{{ url_for('admin_add_product') }}" enctype="multipart/form-data" class="admin-form" id="productForm">
            <div class="form-section">
                <h3>Product Information</h3>
                
                <div class="form-group">
                    <label for="name">Product Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="4"></textarea>
                </div>

                <div class="form-row">
                    <!-- Category Selection -->
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" name="category" required onchange="handleCategoryChange()">
                            <option value="">-- Select Category --</option>
                            <option value="aluminium">Aluminium Scaffolding</option>
                            <option value="h-frames">H Frames</option>
                            <option value="cuplock">Cuplock</option>
                            <option value="accessories">Accessories</option>
                        </select>
                    </div>

                    <!-- Cuplock Type (only shown for Cuplock category) -->
                    <div class="form-group" id="cuplockTypeGroup" style="display: none;">
                        <label for="cuplock_type">Cuplock Type *</label>
                        <select id="cuplock_type" name="cuplock_type" onchange="handleCuplockTypeChange()">
                            <option value="">-- Select Type --</option>
                            <option value="ledger">Ledger</option>
                            <option value="vertical">Vertical</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="weight_per_unit">Weight per Unit (kg)</label>
                    <input type="number" id="weight_per_unit" name="weight_per_unit" step="0.01" value="0">
                </div>

                <!-- Cuplock Ledger Sizes Section -->
                <div id="cuplockLedgerSizes" style="display: none;">
                    <h3>Ledger Sizes & Pricing</h3>
                    <div class="info-box">
                        <p>Add different sizes for this Cuplock Ledger product with individual pricing.</p>
                    </div>
                    
                    <div id="sizesContainer">
                        <!-- Sizes will be dynamically added here -->
                    </div>
                    
                    <button type="button" id="addSizeBtn" class="btn btn-secondary btn-add-size">+ Add Another Size</button>
                </div>

                <!-- Standard Pricing Section (for non-ledger products) -->
                <div id="standardPricing">
                    <h3>Pricing Information</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="price">Buy Price (‚Çπ) *</label>
                            <input type="number" id="price" name="price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="rent_price">Rent Price (‚Çπ/day)</label>
                            <input type="number" id="rent_price" name="rent_price" step="0.01" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="deposit_amount">Deposit Amount (‚Çπ)</label>
                        <input type="number" id="deposit_amount" name="deposit_amount" step="0.01" value="0">
                    </div>
                </div>

                <h3>Product Images</h3>

                <div class="form-group">
                    <label for="product_images">Upload Images</label>
                    <input type="file" id="product_images" name="product_images" multiple accept="image/*">
                    <small>You can upload multiple images. Supported formats: JPG, PNG, GIF, WebP</small>
                </div>

                <!-- Info Box for Cuplock Products -->
                <div id="cuplockInfo" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196F3;">
                    <h4 style="margin-top: 0; color: #1976D2;">‚ÑπÔ∏è Cuplock Product Setup</h4>
                    <p style="margin-bottom: 8px;"><strong>After creating this product, you will need to:</strong></p>
                    <ul style="margin: 0;">
                        <li><strong>Ledger:</strong> Add sizes (0.9m, 1m, 1.2m, etc.) with individual pricing</li>
                        <li><strong>Vertical:</strong> Add sizes and cup configurations with images</li>
                    </ul>
                    <p style="margin-top: 10px; margin-bottom: 0; font-size: 14px; color: #666;">
                        The prices you set above will be used as base/reference prices. 
                        You can configure detailed pricing in the edit page after creation.
                    </p>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary btn-save-product">‚ûï Create Product</button>
                    <a href="{{ url_for('admin_scaffoldings') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function setStandardPricingRequired(isRequired) {
    const price = document.getElementById('price');
    const rent = document.getElementById('rent_price');
    const deposit = document.getElementById('deposit_amount');

    if (isRequired) {
        price.setAttribute('required', 'required');
    } else {
        price.removeAttribute('required');
        price.value = '';
        rent.value = '';
        deposit.value = '';
    }
}

// Track the number of size options added. This is a global variable.
let sizeCount = 0;

// This function runs when the main category dropdown changes.
function handleCategoryChange() {
    const category = document.getElementById('category').value;
    const cuplockTypeGroup = document.getElementById('cuplockTypeGroup');
    const cuplockTypeSelect = document.getElementById('cuplock_type');
    const cuplockInfo = document.getElementById('cuplockInfo');
    const cuplockLedgerSizes = document.getElementById('cuplockLedgerSizes');
    const standardPricing = document.getElementById('standardPricing');
    
    if (category === 'cuplock') {
        // Show cuplock type selector and info box
        cuplockTypeGroup.style.display = 'block';
        cuplockTypeSelect.required = true;
        cuplockInfo.style.display = 'block';
        // IMPORTANT: We do NOT hide/show pricing sections here. 
        // handleCuplockTypeChange() will do that based on the cuplock type.
    }else {
    cuplockTypeGroup.style.display = 'none';
    cuplockTypeSelect.required = false;
    cuplockTypeSelect.value = '';
    cuplockInfo.style.display = 'none';
    cuplockLedgerSizes.style.display = 'none';
    standardPricing.style.display = 'block';

    // üî• REQUIRED for non-cuplock products
    setStandardPricingRequired(true);
}

// This function runs when the cuplock type dropdown changes.
function handleCuplockTypeChange() {
    const cuplockType = document.getElementById('cuplock_type').value;
    const cuplockLedgerSizes = document.getElementById('cuplockLedgerSizes');
    const standardPricing = document.getElementById('standardPricing');

    if (cuplockType === 'ledger') {
        // Ledger ‚Üí sizes only
        cuplockLedgerSizes.style.display = 'block';
        standardPricing.style.display = 'none';

        // üî• FIX: disable required on hidden pricing
        setStandardPricingRequired(false);

        if (sizeCount === 0) {
            addSizeOption();
        }
    } else {
        // Non-ledger ‚Üí normal pricing
        cuplockLedgerSizes.style.display = 'none';
        standardPricing.style.display = 'block';

        // üî• FIX: enable required back
        setStandardPricingRequired(true);
    }
}

// This function adds a new size option to the form.
// This function adds a new size option to the form.
function addSizeOption() {
    sizeCount++; 
    const sizesContainer = document.getElementById('sizesContainer');
    
    const sizeDiv = document.createElement('div');
    sizeDiv.className = 'size-option';
    sizeDiv.id = `size-${sizeCount}`;
    
    // Use template literals to build the HTML for the new size
    sizeDiv.innerHTML = `
        <div class="size-header">
            <h4>Size Option ${sizeCount}</h4>
            ${sizeCount > 1 ? `<button type="button" class="btn btn-remove" onclick="removeSizeOption(${sizeCount})">Remove</button>` : ''}
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="size_name_${sizeCount}">Size Name *</label>
                <!-- ADDED maxlength="50" TO THIS LINE BELOW -->
                <input type="text" id="size_name_${sizeCount}" name="size_name_${sizeCount}" placeholder="e.g., 0.9m, 1m, 1.2m" required maxlength="50">
            </div>
            <div class="form-group">
                <label for="size_price_${sizeCount}">Buy Price (‚Çπ) *</label>
                <input type="number" id="size_price_${sizeCount}" name="size_price_${sizeCount}" step="0.01" required>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="size_rent_price_${sizeCount}">Rent Price (‚Çπ/day)</label>
                <input type="number" id="size_rent_price_${sizeCount}" name="size_rent_price_${sizeCount}" step="0.01" value="0">
            </div>
            <div class="form-group">
                <label for="size_deposit_${sizeCount}">Deposit Amount (‚Çπ)</label>
                <input type="number" id="size_deposit_${sizeCount}" name="size_deposit_${sizeCount}" step="0.01" value="0">
            </div>
        </div>
        <div class="form-group">
            <label for="size_weight_${sizeCount}">Weight (kg)</label>
            <input type="number" id="size_weight_${sizeCount}" name="size_weight_${sizeCount}" step="0.01" value="0">
        </div>
    `;
    
    sizesContainer.appendChild(sizeDiv);
}

// This function removes a size option.
function removeSizeOption(id) {
    const sizeDiv = document.getElementById(`size-${id}`);
    if (sizeDiv) {
        sizeDiv.remove();
        // Optional: Decrement the counter if you want, but it's not strictly necessary
        // sizeCount--; 
    }
}

// This is a key validation function that runs on form submission.
document.getElementById('productForm').addEventListener('submit', function(e) {
    const category = document.getElementById('category').value;
    const cuplockType = document.getElementById('cuplock_type').value;
    
    // IMPORTANT: Check if category is cuplock but no type is selected
    if (category === 'cuplock' && !cuplockType) {
        e.preventDefault(); // Stop the form from submitting
        alert('‚ö†Ô∏è Please select a Cuplock Type (Ledger or Vertical)');
        document.getElementById('cuplock_type').focus();
        return false; // Explicitly return false
    }
    
    // IMPORTANT: Check if category is cuplock ledger but no sizes were added
    if (category === 'cuplock' && cuplockType === 'ledger' && sizeCount === 0) {
        e.preventDefault(); // Stop the form from submitting
        alert('‚ö†Ô∏è Please add at least one size option for the Cuplock Ledger product');
        return false; // Explicitly return false
    }
    
    // If all checks pass, the form will submit normally.
    console.log("Form validation passed. Submitting...");
    return true;
});

// Event listener for the add size button
document.getElementById('addSizeBtn').addEventListener('click', function() {
    addSizeOption();
});

// Initialize the form state on page load
document.addEventListener('DOMContentLoaded', function() {
    handleCategoryChange();
});
</script>

<style>
    /* ===== GLOBAL RESETS ===== */
    * {
        box-sizing: border-box;
    }

    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap; /* Allow wrapping if needed */
        gap: 15px;
    }

    .form-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-section h3 {
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
        margin-top: 30px;
        margin-bottom: 20px;
        font-size: 1.4rem;
    }

    .form-section h3:first-child {
        margin-top: 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #555;
    }

    /* Input Styling - Optimized for Touch */
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 12px; /* Larger padding for touch targets */
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px; /* 16px prevents iOS zoom on focus */
        background-color: #fff;
        transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        border-color: #667eea;
        outline: none;
    }

    .form-group input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 2px dashed #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .form-group small {
        display: block;
        margin-top: 5px;
        color: #666;
        font-size: 13px;
    }

    /* Form Grid Layouts */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    /* Button Styling */
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 5px;
        font-size: 16px; /* Larger font for mobile */
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-remove {
        background: #dc3545;
        color: white;
        padding: 8px 15px;
        font-size: 14px;
    }

    .btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    /* Dynamic Size Options */
    .size-option {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
    }

    .size-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
    }

    .size-header h4 {
        margin: 0;
        color: #555;
        font-size: 1.1rem;
    }

    .info-box {
        background: #f0f7ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #2196F3;
    }

    .info-box p {
        margin: 0;
        color: #555;
    }

    /* Alerts */
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
    .alert-error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }

    /* ===== MOBILE RESPONSIVE CSS ===== */
    @media (max-width: 768px) {
        /* Adjust Container */
        .admin-container {
            padding: 15px;
        }

        /* Header: Stack vertically on mobile */
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .page-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        /* Make buttons full width for easy tapping */
        .btn {
            width: 100%;
            padding: 14px 20px; /* Taller buttons */
        }

        /* Stack main buttons */
        .button-group {
            flex-direction: column;
            width: 100%;
        }

        /* Stack form rows into single column */
        .form-row {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Adjust labels */
        .form-group label {
            margin-bottom: 5px;
            font-size: 14px;
        }

        /* Reduce padding slightly on mobile */
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            padding: 10px;
        }

        /* Adjust Size Options Header */
        .size-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .btn-remove {
            width: 100%;
            margin-top: 10px;
        }

        .btn-add-size {
            width: 100%;
        }

        .info-box {
            padding: 12px;
        }

        .form-container {
            padding: 15px;
        }
    }
</style>

{% endblock %}